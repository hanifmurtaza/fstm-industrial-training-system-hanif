<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <title>Weekly Logbook Entries</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>

<section layout:fragment="content">

  <div class="card p-4 shadow-sm mb-4">

    <!-- Title Row -->
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <h5 class="m-0">
        <i class="bi bi-journal-bookmark-fill me-1"></i>
        Weekly Logbook Entries
      </h5>
    </div>

    <!-- Filter -->
    <form class="row g-2 align-items-end mb-3" method="get" th:action="@{/lecturer/logbook/list}">
      <div class="col-auto">
        <label for="sessionSelect" class="form-label mb-0 fw-semibold">Session</label>
        <select id="sessionSelect" name="session" class="form-select form-select-sm">
          <option value="" th:selected="${selectedSession == null or selectedSession == ''}">All sessions</option>
          <th:block th:each="s : ${sessions}">
            <option th:value="${s}"
                    th:text="${s}"
                    th:selected="${selectedSession != null and selectedSession.equals(s)}"></option>
          </th:block>
        </select>
      </div>

      <div class="col-auto">
        <button type="submit" class="btn btn-primary btn-sm">
          <i class="bi bi-funnel"></i> Filter
        </button>
        <a class="btn btn-outline-secondary btn-sm" th:href="@{/lecturer/logbook/list}">Reset</a>
      </div>
    </form>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle text-center">
        <thead class="table-primary text-center">
        <tr>
          <th>Student Name</th>
          <th>Student ID</th>
          <th>Week Start</th>
          <th>Preview</th>
          <th>File</th>
          <th>Endorsed</th>
          <!-- <th>Export</th> -->
        </tr>
        </thead>

        <tbody>
        <tr th:each="entry : ${logbookWithNames}">

          <!-- student info -->
          <td th:text="${entry.value.name}">Student Name</td>
          <td th:text="${entry.value.studentId}">213793</td>
          <td th:text="${#temporals.format(entry.key.weekStartDate, 'yyyy-MM-dd')}">2025-05-03</td>

          <!-- Preview -->
          <td>
            <button type="button"
                    class="btn btn-warning btn-sm preview-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#previewModal"
                    th:attr="data-id=${entry.key.id}">
              Preview
            </button>

            <!-- Hidden template -->
            <div class="d-none" th:attr="id=|tpl-${entry.key.id}|">
              <div class="lh-lg">
                <div th:if="${entry.key.mainTask}">
                  <strong>Main Task:</strong>
                  <div th:text="${entry.key.mainTask}"></div><br/>
                </div>
                <div th:if="${entry.key.skills}">
                  <strong>Skills:</strong>
                  <div th:text="${entry.key.skills}"></div><br/>
                </div>
                <div th:if="${entry.key.challenges}">
                  <strong>Challenges:</strong>
                  <div th:text="${entry.key.challenges}"></div><br/>
                </div>
                <div th:if="${entry.key.result}">
                  <strong>Result:</strong>
                  <div th:text="${entry.key.result}"></div><br/>
                </div>
                <div th:if="${entry.key.internalNote}">
                  <strong>Internal Note:</strong>
                  <div th:text="${entry.key.internalNote}"></div>
                </div>

                <div th:if="${
                      (entry.key.mainTask == null or entry.key.mainTask == '') and
                      (entry.key.skills == null or entry.key.skills == '') and
                      (entry.key.challenges == null or entry.key.challenges == '') and
                      (entry.key.result == null or entry.key.result == '') and
                      (entry.key.internalNote == null or entry.key.internalNote == '')
                    }" class="text-muted">
                  No content.
                </div>
              </div>
            </div>
          </td>

          <!-- File (View/Download) -->
          <td>
            <span th:if="${entry.key.photoPath == null}" class="text-muted">No file</span>

            <div th:if="${entry.key.photoPath != null}" class="d-flex gap-2 justify-content-center flex-wrap">
              <a th:href="${entry.key.photoPath}"
                 class="btn btn-sm btn-outline-primary"
                 target="_blank">
                View
              </a>

              <a th:href="${entry.key.photoPath}"
                 class="btn btn-sm btn-outline-secondary"
                 download>
                Download
              </a>
            </div>
          </td>

          <!-- Endorse (✅ fixed: use endorsedByLecturer + CSRF) -->
          <td>
            <form th:action="@{/lecturer/logbook/endorse}" method="post" class="d-inline">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

              <!-- ✅ 防止 _csrf 为 null 导致模板报错 -->
              <input type="hidden"
                     th:if="${_csrf != null}"
                     th:name="${_csrf.parameterName}"
                     th:value="${_csrf.token}" />

              <input type="hidden" name="entryId" th:value="${entry.key.id}">
              <input type="hidden" name="session" th:value="${selectedSession}">

              <button type="submit"
                      class="btn btn-sm"
                      th:classappend="${entry.key.endorsedByLecturer} ? ' btn-success' : ' btn-outline-success'">
                <i class="bi bi-check2-circle"></i>
                <span th:text="${entry.key.endorsedByLecturer} ? 'Endorsed' : 'Endorse'">Endorse</span>
              </button>

            </form>

          </td>

          <!-- Export -->
          <!--
<td>
    <a th:href="@{/lecturer/logbook/export/{id}(id=${entry.id})}"
       class="btn btn-sm btn-outline-danger">
        Export
    </a>
</td>
-->


        </tr>
        </tbody>
      </table>
    </div>

    <!-- Footer stats -->
    <div class="mt-2 text-muted small">
      Record 1 to <span th:text="${#lists.size(logbookWithNames)}">0</span>
      daripada <span th:text="${#lists.size(logbookWithNames)}">0</span> record(s)
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title">Logbook Preview</h5>
            <div class="text-muted small mt-1" id="previewMeta">—</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="previewContent" class="lh-lg"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Script -->
  <script>
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.preview-btn');
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      const holder = document.getElementById('tpl-' + id);

      const tr = btn.closest('tr');
      const name = tr ? tr.children[0].textContent.trim() : 'Student';
      const week = tr ? tr.children[2].textContent.trim() : '';

      document.getElementById('previewMeta').textContent = name + ' • Week start ' + week;

      document.getElementById('previewContent').innerHTML =
              holder ? holder.innerHTML : '<div class="text-muted">No content.</div>';
    });
  </script>

</section>

</body>
</html>