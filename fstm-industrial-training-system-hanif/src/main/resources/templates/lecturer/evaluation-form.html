<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}" lang="en">
<head>
  <title>Visiting Lecturer Evaluation</title>
</head>

<body>
<div layout:fragment="content">

  <div class="card shadow-sm p-4">
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
      <div>
        <h4 class="text-primary mb-1">Visiting Lecturer Evaluation Form</h4>
        <div class="text-muted small">Please complete Part A and Part B. Total score will be calculated automatically.</div>
      </div>
      <a class="btn btn-outline-secondary"
         th:href="${selectedSession != null and selectedSession != ''}
                 ? @{/lecturer/evaluation/list(session=${selectedSession})}
                 : @{/lecturer/evaluation/list}">
        ← Back
      </a>
    </div>

    <div class="alert alert-info" th:if="${evaluation.id != null}">
      You have already submitted this evaluation. You may edit and resubmit if necessary.
    </div>

    <form th:action="@{/lecturer/evaluation/submit}" method="post" th:object="${evaluation}">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      <input type="hidden" th:field="*{id}">
      <input type="hidden" th:field="*{visitId}">
      <input type="hidden" th:field="*{lecturerId}">
      <input type="hidden" th:field="*{studentId}">

      <!-- keep session filter for return only (controller uses it just for redirect) -->
      <input type="hidden" name="session" th:value="${selectedSession}"/>

      <!-- ================= Part A ================= -->
      <div class="mt-2">
        <h6 class="fw-bold text-secondary">Part A: Visit Details</h6>
        <div class="row g-3 mt-1">
          <div class="col-md-4">
            <label class="form-label">Visit Date</label>
            <input type="date" class="form-control" th:field="*{visitDate}" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Visit Mode</label>
            <select class="form-select" th:field="*{visitMode}" required>
              <option value="">-- Select --</option>
              <option value="Physical">Physical</option>
              <option value="Online">Online</option>
            </select>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">Discussion Summary (student & supervisor)</label>
          <textarea class="form-control" th:field="*{discussionSummary}" rows="3" required></textarea>
        </div>

        <div class="mt-3">
          <label class="form-label">Overall Observation (on-site)</label>
          <textarea class="form-control" th:field="*{overallObservation}" rows="3" required></textarea>
        </div>
      </div>

      <!-- ================= Part B1 ================= -->
      <div class="mt-4">
        <h6 class="fw-bold text-secondary">Part B1: Student Reflection (Comments)</h6>

        <div class="mt-2">
          <label class="form-label">Role understanding (comment)</label>
          <textarea class="form-control" th:field="*{roleUnderstandingComment}" rows="2" required></textarea>
        </div>

        <div class="mt-3">
          <label class="form-label">Learning understanding (comment)</label>
          <textarea class="form-control" th:field="*{learningUnderstandingComment}" rows="2" required></textarea>
        </div>
      </div>

      <!-- ================= Part B2 (Likert) ================= -->
      <div class="mt-4">
        <h6 class="fw-bold text-secondary">Part B2: Likert Scores (1–5)</h6>
        <!-- Likert Scale Guide -->
        <div class="alert alert-light border mt-2">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="fw-semibold">
              <i class="bi bi-info-circle me-1"></i> Likert Scale Guide (1–5)
            </div>
            <button class="btn btn-sm btn-outline-primary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#likertGuide"
                    aria-expanded="false"
                    aria-controls="likertGuide">
              Show / Hide
            </button>
          </div>

          <div class="collapse mt-2" id="likertGuide">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                <tr>
                  <th style="width:140px;">Indicator</th>
                  <th>Description</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                  <td class="fw-semibold">1. Very Poor</td>
                  <td>Does not demonstrate interest or commitment. Relies entirely on the supervisor.</td>
                </tr>
                <tr>
                  <td class="fw-semibold">2. Poor</td>
                  <td>Carries out only basic tasks. Interaction is minimal and requires close supervision.</td>
                </tr>
                <tr>
                  <td class="fw-semibold">3. Satisfactory</td>
                  <td>Demonstrates moderate commitment. Tasks are completed with guidance.</td>
                </tr>
                <tr>
                  <td class="fw-semibold">4. Good</td>
                  <td>Able to work independently in carrying out tasks. Demonstrates a positive attitude and teamwork.</td>
                </tr>
                <tr>
                  <td class="fw-semibold">5. Excellent</td>
                  <td>Highly proactive, dependable, and consistently demonstrates professional behaviour.</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>


        <div class="row g-3 mt-1">
          <div class="col-md-4">
            <label class="form-label">Reflection (x2 → /10)</label>
            <select class="form-select" th:field="*{reflectionLikert}" required onchange="recalcTotal40()">
              <option value="">-- Select --</option>
              <option th:value="1">1</option>
              <option th:value="2">2</option>
              <option th:value="3">3</option>
              <option th:value="4">4</option>
              <option th:value="5">5</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Engagement (x2 → /10)</label>
            <select class="form-select" th:field="*{engagementLikert}" required onchange="recalcTotal40()">
              <option value="">-- Select --</option>
              <option th:value="1">1</option>
              <option th:value="2">2</option>
              <option th:value="3">3</option>
              <option th:value="4">4</option>
              <option th:value="5">5</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Placement Suitability (/5)</label>
            <select class="form-select" th:field="*{placementSuitabilityLikert}" required onchange="recalcTotal40()">
              <option value="">-- Select --</option>
              <option th:value="1">1</option>
              <option th:value="2">2</option>
              <option th:value="3">3</option>
              <option th:value="4">4</option>
              <option th:value="5">5</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Logbook (/5)</label>
            <select class="form-select" th:field="*{logbookLikert}" required onchange="recalcTotal40()">
              <option value="">-- Select --</option>
              <option th:value="1">1</option>
              <option th:value="2">2</option>
              <option th:value="3">3</option>
              <option th:value="4">4</option>
              <option th:value="5">5</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Lecturer Overall (x2 → /10)</label>
            <select class="form-select" th:field="*{lecturerOverallLikert}" required onchange="recalcTotal40()">
              <option value="">-- Select --</option>
              <option th:value="1">1</option>
              <option th:value="2">2</option>
              <option th:value="3">3</option>
              <option th:value="4">4</option>
              <option th:value="5">5</option>
            </select>
          </div>
        </div>

        <div class="alert alert-info mt-3 mb-0">
          Total (auto-calc): <strong><span id="total40">0</span> / 40</strong>
        </div>
      </div>

      <!-- ================= Remarks ================= -->
      <div class="mt-4">
        <h6 class="fw-bold text-secondary">Additional Remarks (optional)</h6>
        <textarea class="form-control" th:field="*{additionalRemarks}" rows="2"></textarea>
      </div>

      <div class="mt-4">
        <button type="submit" class="btn btn-primary w-100">Submit Evaluation</button>
      </div>
    </form>
  </div>

  <script>
    function val(name){
      const el = document.querySelector(`[name="${name}"]`);
      const v = el ? Number(el.value || 0) : 0;
      return isNaN(v) ? 0 : v;
    }

    function recalcTotal40(){
      const reflection10 = val('reflectionLikert') * 2;
      const engagement10 = val('engagementLikert') * 2;
      const suitability5 = val('placementSuitabilityLikert');
      const logbook5 = val('logbookLikert');
      const overall10 = val('lecturerOverallLikert') * 2;

      const total = reflection10 + engagement10 + suitability5 + logbook5 + overall10;
      document.getElementById('total40').innerText = String(total);
    }

    document.addEventListener('DOMContentLoaded', recalcTotal40);
  </script>

</div>
</body>
</html>