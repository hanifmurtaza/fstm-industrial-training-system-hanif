<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <title>Company Details</title>
</head>
<body>
<section layout:fragment="content" class="container mt-4">

  <a th:href="@{/admin/company-master}" class="btn btn-link mb-3">
    &larr; Back to Company Master
  </a>

  <!-- Generic toast message -->
  <div th:if="${toast}" class="alert alert-info alert-dismissible fade show" role="alert">
    <span th:text="${toast}">Info message</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- Credentials for newly-created supervisor -->
  <div th:if="${showCred} and ${newSupervisorUsername} and ${newSupervisorPassword}"
       class="alert alert-warning alert-dismissible fade show" role="alert">
    <strong>New supervisor account created.</strong><br>
    Username: <code th:text="${newSupervisorUsername}">username@example.com</code><br>
    Temporary password: <code th:text="${newSupervisorPassword}">TempPass123</code>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- Summary card -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h4 class="card-title mb-3" th:text="${company.name}">Company Name</h4>
      <p class="mb-1">
        <strong>Sector:</strong>
        <span th:text="${company.sector} ?: '-'"></span>
      </p>
      <p class="mb-1">
        <strong>Address:</strong><br>
        <span th:text="${company.address} ?: '-'"></span>
      </p>
      <p class="mb-1">
        <strong>Website:</strong>
        <a th:if="${company.website}"
           th:href="${company.website}"
           th:text="${company.website}"
           target="_blank" rel="noopener"></a>
        <span th:if="${company.website} == null">-</span>
      </p>
    </div>
  </div>

  <!-- Edit company form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">
      <strong>Edit Company Details</strong>
    </div>
    <div class="card-body">
      <form th:action="@{/admin/company-master}" method="post">
        <input type="hidden" name="id" th:value="${company.id}"/>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Name</label>
            <input type="text" class="form-control"
                   name="name" th:value="${company.name}" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Sector</label>

            <div class="border rounded-3 p-3 bg-white">
              <div class="row g-2">
                <div class="col-12 col-sm-6" th:each="s : ${sectorOptions}">
                  <label class="w-100 border rounded-3 p-2 d-flex align-items-start gap-2"
                         style="cursor:pointer;">
                    <input class="form-check-input mt-1"
                           type="radio"
                           name="sector"
                           th:value="${s.name()}"
                           th:checked="${company.sector != null and company.sector == s.name()}">
                    <span>
            <span class="fw-semibold"
                  th:text="${#strings.replace(s.name(), '_', ' ')}">SECTOR</span>
          </span>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-text">Select one sector from the official list.</div>
          </div>


          <div class="mb-3">
          <label class="form-label">Address</label>
          <textarea class="form-control" name="address" rows="2"
                    th:text="${company.address}"></textarea>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Default Job Scope</label>
            <textarea class="form-control" name="defaultJobScope" rows="2"
                      th:text="${company.defaultJobScope}"></textarea>
          </div>
          <div class="col-md-3">
            <label class="form-label">Typical Allowance (RM)</label>
            <input type="number" step="0.01" min="0"
                   class="form-control"
                   name="typicalAllowance"
                   th:value="${company.typicalAllowance}">
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
                     name="accommodation"
                     th:checked="${company.accommodation}">
              <label class="form-check-label">
                Accommodation provided
              </label>
            </div>
          </div>
        </div>

        <hr>

        <h6 class="mb-3">Person in Charge (PIC)</h6>
        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label">Name</label>
            <input type="text" class="form-control"
                   name="contactName"
                   th:value="${company.contactName}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Email</label>
            <input type="email" class="form-control"
                   name="contactEmail"
                   th:value="${company.contactEmail}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Phone</label>
            <input type="text" class="form-control"
                   name="contactPhone"
                   th:value="${company.contactPhone}">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Website</label>
          <input type="text" class="form-control"
                 name="website"
                 th:value="${company.website}">
        </div>

        <div class="mb-3">
          <label class="form-label">Internal Notes</label>
          <textarea class="form-control" rows="3"
                    name="notes"
                    th:text="${company.notes}"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">
          Save Changes
        </button>
      </form>
    </div>
  </div>

  <!-- Manage industry supervisors -->
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><strong>Industry Supervisors</strong></span>
      <span class="badge bg-secondary"
            th:text="${#lists.size(supervisors)} + ' linked'">0 linked</span>
    </div>
    <div class="card-body">

      <!-- Linked supervisors list -->
      <h6 class="mb-2">Currently linked</h6>

      <ul class="list-group list-group-flush mb-3"
          th:if="${#lists.isEmpty(supervisors) == false}">
        <li class="list-group-item px-0"
            th:each="u : ${supervisors}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold"
                   th:text="${u.name != null ? u.name : u.username}">
                Supervisor Name
              </div>
              <div class="small text-muted">
                <span th:text="${u.username}">username</span>
              </div>
            </div>
            <div class="btn-group btn-group-sm">
              <!-- Edit opens modal -->
              <button type="button"
                      class="btn btn-outline-primary"
                      data-bs-toggle="modal"
                      th:attr="data-bs-target='#editSupModal-' + ${u.id}">
                Edit
              </button>

              <!-- Unlink -->
              <form th:action="@{'/admin/company-master/' + ${company.id} + '/supervisors/' + ${u.id} + '/unlink'}"
                    method="post" class="d-inline">
                <button type="submit" class="btn btn-outline-secondary">
                  Unlink
                </button>
              </form>

              <!-- Delete (danger) -->
              <form th:action="@{'/admin/company-master/' + ${company.id} + '/supervisors/' + ${u.id} + '/delete'}"
                    method="post" class="d-inline"
                    onsubmit="return confirm('Delete this supervisor account? This action cannot be undone.');">
                <button type="submit" class="btn btn-outline-danger">
                  Delete
                </button>
              </form>
            </div>
          </div>
        </li>
      </ul>

      <div class="text-muted small mb-3" th:if="${#lists.isEmpty(supervisors)}">
        No linked supervisor accounts yet.
      </div>

      <hr>

      <!-- Link existing supervisor -->
      <h6 class="mb-2">Link existing supervisor account</h6>
      <form class="row g-2 align-items-end mb-4"
            th:action="@{'/admin/company-master/' + ${company.id} + '/link-supervisor'}"
            method="post">

        <div class="col-md-6">
          <label class="form-label">Select industry user</label>
          <select class="form-select" name="supervisorId" required>
            <option value="" disabled selected>-- choose industry user --</option>
            <option th:each="x : ${availableSupervisors}"
                    th:value="${x.id}"
                    th:text="${(x.name != null ? x.name : x.username) + ' (' + x.username + ')'}">
              John Doe (john@company.com)
            </option>
          </select>
        </div>

        <div class="col-md-3">
          <button type="submit" class="btn btn-outline-primary w-100">
            Link to this company
          </button>
        </div>
      </form>

      <!-- Create new supervisor -->
      <h6 class="mb-2">Create new supervisor account</h6>
      <p class="small text-muted">
        A new user with role <code>industry</code> will be created and automatically linked
        to <span th:text="${company.name}">Company</span>.
      </p>

      <form th:action="@{'/admin/company-master/' + ${company.id} + '/create-supervisor'}"
            method="post">
        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Username / Email</label>
            <input type="email" class="form-control" name="username" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">
              Password
              <span class="text-muted small">(optional, auto-generate if empty)</span>
            </label>
            <input type="text" class="form-control" name="password">
          </div>
        </div>

        <button type="submit" class="btn btn-success">
          Create Supervisor Account
        </button>
      </form>

    </div>
  </div>

  <!-- Edit supervisor modals -->
  <div th:each="u : ${supervisors}">
    <div class="modal fade"
         th:id="'editSupModal-' + ${u.id}"
         tabindex="-1"
         aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit supervisor</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form th:action="@{'/admin/company-master/' + ${company.id} + '/supervisors/' + ${u.id} + '/update'}"
                method="post">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control"
                       name="name"
                       th:value="${u.name}">
              </div>
              <div class="mb-3">
                <label class="form-label">Username / Email</label>
                <input type="email" class="form-control"
                       name="username"
                       th:value="${u.username}">
              </div>
              <p class="small text-muted mb-0">
                This account remains linked to
                <span th:text="${company.name}">company</span>.
              </p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

</section>
</body>
</html>
