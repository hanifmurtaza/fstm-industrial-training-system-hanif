<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Company Detail • UPM Industrial Training</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap + Icons + Font -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Global theme -->
  <link th:href="@{/app.css}" rel="stylesheet">

  <style>
    :root{
      --border: rgba(148,163,184,.25);
      --muted:#64748b;
      --ink:#0f172a;
      --bg:#f5f7fa;
    }
    body{
      font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .container-narrow{ max-width:1240px; }
    .card-soft{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 12px 30px rgba(15,23,42,.10);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      padding:6px 12px;
      border-radius:999px;
      background:#eef2ff;
      color:#1e40af;
      font-size:.85rem;
      font-weight:800;
    }
    .muted{ color:var(--muted); }
    .btn-rounded{ border-radius:12px; padding:.6rem .95rem; }
    .btn-sm.btn-rounded{ border-radius:10px; padding:.45rem .7rem; }
    .kpi{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px 14px;
      background:#fff;
    }
    .kpi .label{ font-size:.78rem; letter-spacing:.05em; font-weight:800; color:#64748b; text-transform:uppercase; }
    .kpi .value{ font-weight:900; font-size:1.05rem; }
    .badge-pill{
      border-radius:999px;
      padding:.38rem .65rem;
      font-weight:900;
      font-size:.72rem;
      letter-spacing:.04em;
      border:1px solid transparent;
      display:inline-block;
      white-space:nowrap;
    }
    .b-blue{ background:rgba(59,130,246,.12); color:#1d4ed8; border-color:rgba(59,130,246,.20); }
    .b-green{ background:rgba(34,197,94,.15); color:#166534; border-color:rgba(34,197,94,.22); }
    .b-soft{ background:#eef2f7; color:#475569; border-color:rgba(71,85,105,.18); }
    .nav-tabs .nav-link{
      font-weight:800;
      color:#334155;
      border-radius:12px 12px 0 0;
    }
    .nav-tabs .nav-link.active{
      color:#1d4ed8;
    }
    .table thead th{
      background:#fff;
      border-bottom:1px solid var(--border);
      font-weight:800;
      color:#334155;
      font-size:.9rem;
      white-space:nowrap;
    }
  </style>
</head>

<body>

<!-- Top Navbar (match your newer admin pages) -->
<nav class="navbar navbar-expand-lg appbar">
  <div class="container container-narrow">
    <a class="navbar-brand d-flex align-items-center gap-2" th:href="@{/admin/dashboard}">
      <img th:src="@{/Picture1.png}" alt="UPM" style="height:28px">
      <span>Admin Panel</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navAdminCompanyDetail">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navAdminCompanyDetail" class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a th:href="@{/admin/students}" class="nav-link">Students</a></li>
        <li class="nav-item"><a th:href="@{/admin/lecturers}" class="nav-link">Lecturers</a></li>
        <li class="nav-item"><a th:href="@{/admin/evaluations}" class="nav-link">Evaluations</a></li>
        <li class="nav-item"><a th:href="@{/admin/company-master}" class="nav-link">Company Directory</a></li>
        <li class="nav-item"><a th:href="@{/admin/company-info(status='PENDING')}" class="nav-link">Submissions</a></li>
        <li class="nav-item"><a th:href="@{/admin/placements}" class="nav-link">Placements</a></li>
        <li class="nav-item"><a th:href="@{/admin/announcements}" class="nav-link">Announcements</a></li>
        <li class="nav-item">
          <form th:action="@{/logout}" method="post" class="d-flex align-items-center h-100 m-0 p-0">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="submit" class="nav-link btn btn-link p-0 m-0 border-0 bg-transparent">
              Logout
            </button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>

<main class="container container-narrow py-4">

  <!-- Header -->
  <div class="d-flex flex-wrap align-items-start justify-content-between gap-2 mb-3">
    <div>
      <span class="pill"><i class="bi bi-building"></i> Company Detail</span>
      <h1 class="h4 mb-0 mt-2" th:text="${company.name}">Company Name</h1>
      <div class="muted mt-1">Manage company record and linked industry supervisor accounts.</div>
    </div>

    <div class="d-flex flex-wrap gap-2 align-items-center">
      <a class="btn btn-outline-secondary btn-rounded" th:href="@{/admin/company-master}">
        <i class="bi bi-arrow-left me-1"></i> Back
      </a>

      <form th:action="@{|/admin/company-master/${company.id}/delete|}" method="post"
      onsubmit="return confirm('Delete this company? It may be referenced by placements or other data.');">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <button class="btn btn-outline-danger btn-rounded" type="submit">
          <i class="bi bi-trash me-1"></i> Delete company
        </button>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div th:if="${toast}" class="alert alert-info alert-dismissible fade show card-soft" role="alert">
    <i class="bi bi-info-circle me-1"></i>
    <span th:text="${toast}">Info message</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <!-- New supervisor credentials -->
  <div th:if="${showCred} and ${newSupervisorUsername} and ${newSupervisorPassword}"
       class="alert alert-warning alert-dismissible fade show card-soft" role="alert">
    <strong>New supervisor account created.</strong><br>
    Username: <code th:text="${newSupervisorUsername}">username@example.com</code><br>
    Temporary password: <code th:text="${newSupervisorPassword}">TempPass123</code>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <!-- Summary KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-lg-4">
      <div class="kpi">
        <div class="label">Sector</div>
        <div class="value">
          <span class="badge-pill b-blue"
                th:text="${company.sector != null ? #strings.replace(company.sector, '_', ' ') : '—'}">—</span>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="kpi">
        <div class="label">Accommodation</div>
        <div class="value">
          <span class="badge-pill"
                th:classappend="${company.accommodation} ? 'b-green' : 'b-soft'"
                th:text="${company.accommodation} ? 'Yes' : 'No'">No</span>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="kpi">
        <div class="label">Rating</div>
        <div class="value">
          <span th:if="${company.ratingAvg != null}"
                th:text="${#numbers.formatDecimal(company.ratingAvg, 1, 1)} + ' ★ (' + company.ratingCount + ')'}">—</span>
          <span th:if="${company.ratingAvg == null}" class="muted">—</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-details" type="button" role="tab">
        <i class="bi bi-pencil-square me-1"></i> Details
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-supervisors" type="button" role="tab">
        <i class="bi bi-people me-1"></i> Supervisors
        <span class="ms-1 badge bg-secondary" th:text="${#lists.size(supervisors)}">0</span>
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- =========================
         DETAILS TAB
    ========================== -->
    <div class="tab-pane fade show active" id="tab-details" role="tabpanel">
      <div class="card-soft p-4 mt-3">

        <form th:action="@{/admin/company-master}" method="post">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <input type="hidden" name="id" th:value="${company.id}"/>

          <div class="row g-3">
            <div class="col-md-7">
              <label class="form-label fw-semibold">Company name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="name" th:value="${company.name}" required>
            </div>

            <div class="col-md-5">
              <label class="form-label fw-semibold">Sector</label>
              <!-- ✅ dropdown (clean) -->
              <select class="form-select" name="sector">
                <option value="">— Select sector —</option>
                <option th:each="s : ${sectorOptions}"
                        th:value="${s.name()}"
                        th:selected="${company.sector != null and company.sector == s.name()}"
                        th:text="${#strings.replace(s.name(), '_', ' ')}">
                  SECTOR
                </option>
              </select>
              <div class="form-text">Use the official faculty sector list (enum).</div>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold">Address</label>
              <textarea class="form-control" name="address" rows="2" th:text="${company.address}"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Default job scope</label>
              <textarea class="form-control" name="defaultJobScope" rows="3"
                        th:text="${company.defaultJobScope}"></textarea>
            </div>

            <div class="col-md-3">
              <label class="form-label fw-semibold">Typical allowance (RM)</label>
              <input type="number" step="0.01" min="0" class="form-control"
                     name="typicalAllowance" th:value="${company.typicalAllowance}">
            </div>

            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="acc"
                       name="accommodation" value="true"
                       th:checked="${company.accommodation} == true">
                <label class="form-check-label fw-semibold" for="acc">Accommodation provided</label>
              </div>
            </div>

            <div class="col-12"><hr class="my-2"></div>

            <div class="col-12">
              <div class="fw-bold mb-2">Person in Charge (PIC)</div>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-semibold">PIC name</label>
              <input type="text" class="form-control" name="contactName" th:value="${company.contactName}">
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">PIC email</label>
              <input type="email" class="form-control" name="contactEmail" th:value="${company.contactEmail}">
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">PIC phone</label>
              <input type="text" class="form-control" name="contactPhone" th:value="${company.contactPhone}">
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Website</label>
              <input type="text" class="form-control" name="website" th:value="${company.website}">
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Internal notes</label>
              <textarea class="form-control" rows="3" name="notes" th:text="${company.notes}"></textarea>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-4">
            <button type="submit" class="btn btn-primary btn-rounded">
              <i class="bi bi-check2-circle me-1"></i> Save changes
            </button>
            <a th:href="@{/admin/company-master}" class="btn btn-outline-secondary btn-rounded">Cancel</a>
          </div>

        </form>

      </div>
    </div>

    <!-- =========================
         SUPERVISORS TAB
    ========================== -->
    <div class="tab-pane fade" id="tab-supervisors" role="tabpanel">
      <div class="card-soft p-4 mt-3">

        <!-- Linked supervisors list -->
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
          <div>
            <div class="fw-bold">Linked industry supervisors</div>
            <div class="muted small">These accounts can endorse logbooks and submit supervisor evaluation.</div>
          </div>
          <span class="badge bg-secondary" th:text="${#lists.size(supervisors)} + ' linked'">0 linked</span>
        </div>

        <div th:if="${#lists.isEmpty(supervisors)}" class="text-muted">
          No linked supervisor accounts yet.
        </div>

        <div th:if="${#lists.isEmpty(supervisors) == false}" class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
            <tr>
              <th style="min-width:240px;">Supervisor</th>
              <th style="min-width:260px;">Username</th>
              <th class="text-end">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="u : ${supervisors}">
              <td>
                <div class="fw-semibold" th:text="${u.name != null ? u.name : u.username}">Name</div>
              </td>
              <td>
                <span class="text-muted" th:text="${u.username}">username</span>
              </td>
              <td class="text-end text-nowrap">
                <button type="button" class="btn btn-sm btn-outline-primary btn-rounded"
                        data-bs-toggle="modal"
                        th:attr="data-bs-target='#editSupModal-' + ${u.id}">
                  <i class="bi bi-pencil me-1"></i> Edit
                </button>

                <form th:action="@{'/admin/company-master/' + ${company.id} + '/supervisors/' + ${u.id} + '/unlink'}"
                      method="post" class="d-inline">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                  <button type="submit" class="btn btn-sm btn-outline-secondary btn-rounded">
                    Unlink
                  </button>
                </form>

                <form th:action="@{'/admin/company-master/' + ${company.id} + '/supervisors/' + ${u.id} + '/delete'}"
                      method="post" class="d-inline"
                      onsubmit="return confirm('Delete this supervisor account? This action cannot be undone.');">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                  <button type="submit" class="btn btn-sm btn-outline-danger btn-rounded" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <hr class="my-4">

        <!-- Link existing supervisor -->
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="fw-bold mb-1">Link existing industry user</div>
            <div class="muted small mb-2">Choose an existing industry account and link to this company.</div>

            <form class="row g-2 align-items-end"
                  th:action="@{'/admin/company-master/' + ${company.id} + '/link-supervisor'}"
                  method="post">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              <div class="col-12">
                <label class="form-label fw-semibold">Select industry user</label>
                <select class="form-select" name="supervisorId" required>
                  <option value="" disabled selected>— choose industry user —</option>
                  <option th:each="x : ${availableSupervisors}"
                          th:value="${x.id}"
                          th:text="${(x.name != null ? x.name : x.username) + ' (' + x.username + ')'}">
                    User
                  </option>
                </select>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-outline-primary btn-rounded w-100">
                  <i class="bi bi-link-45deg me-1"></i> Link to this company
                </button>
              </div>
            </form>
          </div>

          <!-- Create new supervisor -->
          <div class="col-12 col-lg-6">
            <div class="fw-bold mb-1">Create new supervisor</div>
            <div class="muted small mb-2">
              A new user with role <code>industry</code> will be created and linked automatically.
            </div>

            <form th:action="@{'/admin/company-master/' + ${company.id} + '/create-supervisor'}"
                  method="post" class="card-soft p-3" style="box-shadow:none;">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Name</label>
                  <input type="text" class="form-control" name="name" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Username / Email</label>
                  <input type="email" class="form-control" name="username" required>
                </div>
                <div class="col-12">
                  <label class="form-label fw-semibold">
                    Password <span class="muted small">(optional — auto-generate if empty)</span>
                  </label>
                  <input type="text" class="form-control" name="password">
                </div>

                <div class="col-12 d-grid">
                  <button type="submit" class="btn btn-success btn-rounded">
                    <i class="bi bi-person-plus me-1"></i> Create supervisor account
                  </button>
                </div>
              </div>
            </form>
          </div>

        </div>

      </div>
    </div>
  </div>

  <!-- Edit supervisor modals (keep your existing backend routes) -->
  <div th:each="u : ${supervisors}">
    <div class="modal fade" th:id="'editSupModal-' + ${u.id}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content" style="border-radius:16px;">
          <div class="modal-header">
            <h5 class="modal-title">Edit supervisor</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <form th:action="@{'/admin/company-master/' + ${company.id} + '/supervisors/' + ${u.id} + '/update'}"
                method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label fw-semibold">Name</label>
                <input type="text" class="form-control" name="name" th:value="${u.name}">
              </div>
              <div class="mb-3">
                <label class="form-label fw-semibold">Username / Email</label>
                <input type="email" class="form-control" name="username" th:value="${u.username}">
              </div>
              <p class="small muted mb-0">
                This account remains linked to <span th:text="${company.name}">company</span>.
              </p>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary btn-rounded" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary btn-rounded">Save changes</button>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>

</main>

<footer class="text-center text-muted py-4 small">
  © <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}">2026</span>, Faculty of Food Science and Technology, UPM
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
