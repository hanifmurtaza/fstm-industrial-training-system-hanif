<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Evaluations • UPM Industrial Training</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap + Icons + Font -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- your global css -->
    <link th:href="@{/app.css}" rel="stylesheet">

    <style>
        :root{
            --border: rgba(148,163,184,.25);
            --muted:#64748b;
            --ink:#0f172a;
            --bg:#f5f7fa;
        }
        body{ font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; background:var(--bg); color:var(--ink); }
        .container-narrow{ max-width:1240px; }

        .pill{
            display:inline-flex; gap:8px; align-items:center;
            padding:6px 12px; border-radius:999px;
            background:#eef2ff; color:#1e40af;
            font-size:.85rem; font-weight:800;
        }
        .page-title{ letter-spacing:-0.2px; }
        .muted{ color:var(--muted); }

        .card-soft{
            background:#fff;
            border:1px solid var(--border);
            border-radius:18px;
            box-shadow:0 12px 30px rgba(15,23,42,.10);
        }

        .btn-rounded{ border-radius:12px; padding:.6rem .95rem; }
        .btn-sm.btn-rounded{ padding:.45rem .7rem; border-radius:10px; }

        .badge-pill{
            border-radius:999px;
            padding:.45rem .7rem;
            font-weight:900;
            font-size:.72rem;
            letter-spacing:.04em;
            border:1px solid transparent;
            white-space:nowrap;
            display:inline-block;
        }
        .badge-ok{ background:#E6F4EA; color:#1F7A39; border-color:rgba(31,122,57,.15); }
        .badge-na{ background:#EEF2F7; color:#475569; border-color:rgba(71,85,105,.18); }

        .table thead th{
            background:#fff;
            border-bottom:1px solid var(--border);
            font-weight:800;
            color:#334155;
            font-size:.9rem;
            white-space:nowrap;
        }
        .table tbody td{ vertical-align:middle; }

        .col-narrow{ width:1%; white-space:nowrap; }
        .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

        /* Filter bar improvements */
        .filter-card{
            border-radius:18px;
            background:#fff;
            border:1px solid rgba(148,163,184,.25);
            box-shadow:0 12px 30px rgba(15,23,42,.08);
        }

        .filter-grid{
            display:grid;
            grid-template-columns: 1.6fr 0.9fr 1.1fr auto; /* search, session, dept, button */
            gap:12px;
            align-items:end;
        }

        @media (max-width: 992px){
            .filter-grid{ grid-template-columns: 1fr; }
        }

        .form-label.small-label{
            font-size:.82rem;
            font-weight:700;
            color:#334155;
            margin-bottom:6px;
        }

        .input-shell .form-control,
        .input-shell .form-select{
            height:44px;
            border-radius:14px;
            border:1px solid rgba(148,163,184,.28);
        }

        .input-shell .input-group-text{
            height:44px;
            border-radius:14px 0 0 14px;
            border:1px solid rgba(148,163,184,.28);
            background:#fff;
        }

        .btn-filter{
            height:44px;
            border-radius:14px;
            padding:0 18px;
            font-weight:800;
            display:inline-flex;
            align-items:center;
            gap:8px;
        }

        .meta-row{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-top:10px;
            padding-top:10px;
            border-top:1px dashed rgba(148,163,184,.30);
            color:#64748b;
            font-size:.9rem;
        }

        /* ===== Compact table layout ===== */
        .table-compact{
            font-size:0.86rem;
        }

        .table-compact th,
        .table-compact td{
            padding:.45rem .6rem;
            vertical-align:middle;
        }

        .table-compact thead th{
            white-space:nowrap;
        }

        /* prevent awkward wrapping */
        .nowrap{
            white-space:nowrap;
        }

        /* narrow utility columns */
        .col-narrow{ width:1%; white-space:nowrap; }

        /* badges smaller */
        .badge-pill{
            font-size:.72rem;
            padding:.35rem .6rem;
            border-radius:999px;
        }

        /* action button compact */
        .btn-view{
            padding:.35rem .55rem;
            font-size:.78rem;
        }


    </style>
</head>

<body>

<!-- Navbar (match dashboard) -->
<nav class="navbar navbar-expand-lg appbar">
    <div class="container container-narrow">
        <a class="navbar-brand d-flex align-items-center gap-2" th:href="@{/admin/dashboard}">
            <img th:src="@{/Picture1.png}" alt="UPM" style="height:28px">
            <span>Admin Panel • UPM Industrial Training</span>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navAdminEval">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div id="navAdminEval" class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a th:href="@{/admin/students}" class="nav-link">Students</a></li>
                <li class="nav-item"><a th:href="@{/admin/lecturers}" class="nav-link">Lecturers</a></li>
                <li class="nav-item"><a th:href="@{/admin/evaluations}" class="nav-link active">Evaluations</a></li>
                <li class="nav-item"><a th:href="@{/admin/company-master}" class="nav-link">Company Master</a></li>
                <li class="nav-item"><a th:href="@{/admin/company-info(status='PENDING')}" class="nav-link">Submissions</a></li>
                <li class="nav-item"><a th:href="@{/admin/placements}" class="nav-link">Placements</a></li>
                <li class="nav-item"><a th:href="@{/logout}" class="nav-link">Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<main class="container container-narrow py-4">

    <!-- Header -->
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
            <span class="pill"><i class="bi bi-clipboard-check"></i> Evaluations</span>
            <h1 class="h4 page-title mb-0 mt-2">Evaluations Overview</h1>
            <div class="muted mt-1">Search by student name/matric and filter by session.</div>
        </div>

        <div class="d-flex gap-2">
            <a class="btn btn-outline-primary btn-rounded" th:href="@{/admin/dashboard}">
                <i class="bi bi-arrow-left me-1"></i> Dashboard
            </a>
            <a class="btn btn-success btn-rounded"
               th:href="@{/admin/evaluations/export(search=${search}, session=${selectedSession})}">
                <i class="bi bi-file-earmark-excel me-1"></i> Export Excel
            </a>
        </div>
    </div>

    <!-- Filters -->
    <form method="get" th:action="@{/admin/evaluations}" class="filter-card p-3 p-md-4 mb-3">
        <div class="filter-grid">

            <!-- Search -->
            <div class="input-shell">
                <label class="form-label small-label">Search</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" name="search" class="form-control"
                           placeholder="Search by student name or matric"
                           th:value="${search}">
                </div>
            </div>

            <!-- Session -->
            <div class="input-shell">
                <label class="form-label small-label">Session</label>
                <select name="session" class="form-select">
                    <option value="" th:selected="${selectedSession == null || selectedSession == ''}">All Sessions</option>
                    <option th:each="s : ${sessions}"
                            th:value="${s}"
                            th:text="${s}"
                            th:selected="${s == selectedSession}">
                    </option>
                </select>
            </div>

            <!-- Department -->
            <div class="input-shell">
                <label class="form-label small-label">Department</label>
                <select name="department" class="form-select">
                    <option value="" th:selected="${selectedDepartment == null || selectedDepartment == ''}">All Departments</option>
                    <option th:each="d : ${departmentOptions}"
                            th:value="${d.name()}"
                            th:text="${#strings.replace(d.name(), '_', ' ')}"
                            th:selected="${d.name() == selectedDepartment}">
                    </option>
                </select>
            </div>

            <!-- Button -->
            <div class="d-grid">
                <button class="btn btn-primary btn-filter" type="submit">
                    <i class="bi bi-funnel"></i> Filter
                </button>
            </div>

        </div>

        <!-- keep size -->
        <input type="hidden" name="size" th:value="${size}"/>

        <div class="meta-row">
            <div>
                Total Students:
                <span class="fw-semibold" th:text="${students != null ? students.totalElements : 0}">0</span>
            </div>

            <div class="d-flex gap-2">
                <!-- optional quick clear -->
                <a class="btn btn-outline-secondary btn-sm btn-filter"
                   style="height:34px;border-radius:12px;padding:0 14px;font-weight:700;"
                   th:href="@{/admin/evaluations}">
                    Clear
                </a>
            </div>
        </div>
    </form>


    <!-- Table -->
    <div class="card-soft overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle table-compact">
            <thead>
                <tr>
                    <th class="col-narrow">No</th>
                    <th style="min-width:220px;">Student</th>
                    <th class="col-narrow">Matric</th>
                    <th class="col-narrow">Department</th>
                    <th class="nowrap">Session</th>
                    <th class="col-narrow">VL (40)</th>
                    <th class="col-narrow">Industry (40)</th>
                    <th class="col-narrow">Logbook (10)</th>
                    <th class="col-narrow">Report (10)</th>
                    <th class="col-narrow">Total</th>
                    <th class="col-narrow">Grade</th>
                    <th class="col-narrow">Action</th>
                </tr>
                </thead>

                <tbody>
                <tr th:if="${students == null or students.totalElements == 0}">
                    <td colspan="11" class="text-center text-muted py-5">
                        <i class="bi bi-clipboard-x fs-3 d-block mb-2"></i>
                        No students found.
                    </td>
                </tr>

                <tr th:each="s, st : ${students.content}">
                    <td th:text="${st.index + 1}">1</td>

                    <td>
                        <div class="fw-semibold text-truncate" style="max-width:180px"
                             th:text="${s.name}">Student Name</div>
                        <div class="text-muted small" th:text="${s.studentId}">202872</div>
                    </td>

                    <td class="mono" th:text="${s.studentId != null ? s.studentId : '-'}">-
                    <td class="nowrap small"
                        th:text="${s.department != null ? #strings.replace(s.department,'_',' ') : '-'}">
                    </td>
                    <td class="nowrap" th:text="${s.session}">2026/2027-1</td>


                    <!-- VL (40) -->
                    <td>
                        <th:block th:with="vl=${vlScoreByStudentId[s.id]}">
                            <span th:if="${vl != null}" class="badge-pill badge-ok"
                                  th:text="${vl + ' / 40'}">0 / 40</span>
                            <span th:if="${vl == null}" class="badge-pill badge-na">NO DATA</span>
                        </th:block>
                    </td>

                    <!-- Industry (40) -->
                    <td>
                        <th:block th:with="sa=${assessmentByStudentId[s.id]}">
                            <span th:if="${sa != null}" class="badge-pill badge-ok"
                                  th:text="${((sa.isAttributes30 != null ? sa.isAttributes30 : 0) + (sa.isOverall10 != null ? sa.isOverall10 : 0)) + ' / 40'}">
                                0 / 40
                            </span>
                            <span th:if="${sa == null}" class="badge-pill badge-na">NO DATA</span>
                        </th:block>
                    </td>

                    <!-- Logbook (10) -->
                    <td>
                        <th:block th:with="lb=${logbookScoreByStudentId[s.id]}">
                            <span th:if="${lb != null}" class="badge-pill badge-ok"
                                  th:text="${lb + ' / 10'}">0 / 10</span>
                            <span th:if="${lb == null}" class="badge-pill badge-na">PENDING</span>
                        </th:block>
                    </td>

                    <!-- Report (10) -->
                    <td>
                        <th:block th:with="rep=${reportScoreByStudentId[s.id]}">
                            <span th:if="${rep != null}" class="badge-pill badge-ok"
                                  th:text="${rep + ' / 10'}">0 / 10</span>
                            <span th:if="${rep == null}" class="badge-pill badge-na">NO DATA</span>
                        </th:block>
                    </td>

                    <!-- Total -->
                    <td>
                        <th:block th:with="tot=${totalByStudentId[s.id]}">
                            <span th:if="${tot != null}" class="fw-semibold"
                                  th:text="${#numbers.formatDecimal(tot, 1, 2)}">0.00</span>
                            <span th:if="${tot == null}" class="text-muted">-</span>
                        </th:block>
                    </td>

                    <!-- Grade -->
                    <td>
                        <th:block th:with="g=${gradeByStudentId[s.id]}">
                            <span th:if="${g != null}" class="fw-semibold" th:text="${g}">-</span>
                            <span th:if="${g == null}" class="text-muted">-</span>
                        </th:block>
                    </td>

                    <!-- Action (enable if any component exists) -->
                    <td class="text-end">
                        <th:block
                                th:with="
                                  sa=${assessmentByStudentId[s.id]},
                                  vl=${vlScoreByStudentId[s.id]},
                                  rep=${reportScoreByStudentId[s.id]},
                                  lb=${logbookScoreByStudentId[s.id]},
                                  tot=${totalByStudentId[s.id]},
                                  hasAny=${sa != null || vl != null || rep != null || lb != null || tot != null}">
                            <a th:if="${hasAny}"
                               class="btn btn-sm btn-primary btn-rounded"
                               th:href="@{/admin/evaluations/{id}(id=${s.id})}">
                                <i class="bi bi-eye me-1"></i> View
                            </a>
                            <button th:if="${!hasAny}" class="btn btn-sm btn-outline-secondary btn-rounded" disabled>
                                <i class="bi bi-eye me-1"></i> View
                            </button>
                        </th:block>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination (RESTORED) -->
    <nav class="mt-3" th:if="${students != null && students.totalPages > 1}">
        <ul class="pagination pagination-sm mb-0">
            <li class="page-item" th:classappend="${students.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/admin/evaluations(page=${currentPage-1}, size=${size}, search=${search}, session=${selectedSession})}">
                    Previous
                </a>
            </li>

            <li class="page-item"
                th:each="i : ${#numbers.sequence(0, students.totalPages - 1)}"
                th:classappend="${i == currentPage} ? 'active'">
                <a class="page-link"
                   th:href="@{/admin/evaluations(page=${i}, size=${size}, search=${search}, session=${selectedSession})}"
                   th:text="${i + 1}">1</a>
            </li>

            <li class="page-item" th:classappend="${students.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/admin/evaluations(page=${currentPage+1}, size=${size}, search=${search}, session=${selectedSession})}">
                    Next
                </a>
            </li>
        </ul>
    </nav>

</main>

<footer class="text-center text-muted py-4 small">
    © <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}">2025</span>, Faculty of Food Science and Technology, UPM
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
