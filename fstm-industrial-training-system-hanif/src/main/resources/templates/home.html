<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.thymeleaf.org/thymeleaf-extras-layout"
      layout:decorate="~{layout}" lang="en">
<head>
    <title>Home</title>
</head>
<body>
<div layout:fragment="content">

    <!-- È°∂ÈÉ®Ê¨¢Ëøé -->
    <div class="card shadow-sm p-4 mb-3">
        <h5 class="mb-1">
            Welcome back,
            <span th:text="${userName} ?: (${session.user} != null ? ${session.user.name} : 'Visiting Lecturer')">
              Visiting Lecturer
            </span> üëã
        </h5>
    </div>

    <!-- === Announcements + Calendar === -->
    <div class="row g-3">
        <!-- Announcements -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <h6 class="m-0">Announcements</h6>
                        <!-- Â∑≤ÊåâË¶ÅÊ±ÇÁßªÈô§ View evaluations ÈìæÊé• -->
                    </div>

                    <!-- ÂàóË°® -->
                    <ul class="list-group list-group-flush mt-3"
                        th:if="${announcements != null and !#lists.isEmpty(announcements)}">
                        <li class="list-group-item px-0" th:each="a : ${announcements}">
                            <div class="d-flex">
                                <div class="me-2 mt-1">
                                    <i class="bi bi-file-earmark-arrow-down text-primary"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <a class="link-primary text-decoration-none fw-semibold"
                                       th:href="@{'/announcement/download/' + ${a.id}}"
                                       th:text="${a.title}">Announcement title</a>
                                    <div class="text-muted small" th:text="${a.originalName}">file.pdf</div>
                                    <div class="text-muted small mt-1">
                                        <i class="bi bi-calendar-event me-1"></i>
                                        <span th:text="${#temporals.format(a.uploadedAt, 'yyyy-MM-dd HH:mm')}">2025-10-26</span>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>

                    <!-- Á©∫Áä∂ÊÄÅ -->
                    <div class="text-muted small py-4 text-center"
                         th:if="${announcements == null or #lists.isEmpty(announcements)}">
                        <i class="bi bi-inbox me-1"></i>No announcements yet.
                    </div>

                    <!-- Â∑≤ÊåâË¶ÅÊ±ÇÂà†Èô§‰∏é Evaluation Áõ∏ÂÖ≥ÁöÑÊèêÁ§∫ËØ≠ -->
                </div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <h6 class="m-0">Schedule Calendar</h6>
                        <!-- ÁÆÄÊ¥ÅËµ∑ËßÅÔºåËøôÈáå‰øùÁïôÂâØÊ†áÈ¢ò‰πüÂèØ‰ª•ÂéªÊéâ -->
                        <span class="text-muted small">Your visits at a glance</span>
                    </div>
                    <div id="vl-calendar" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- FullCalendar assets -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const el = document.getElementById('vl-calendar');
            if (!el) return;

            // Â¶ÇÈúÄÊòæÁ§∫‰∫ã‰ª∂Ôºå‰øùÁïôÊ≠§Êé•Âè£Ôºõ‰∏çÈúÄË¶ÅÂèØÊîπ‰∏∫ const events = [];
            let events = [];
            try {
                const res = await fetch('/lecturer/dashboard/events', { credentials: 'same-origin', cache: 'no-store' });
                events = res.ok ? await res.json() : [];
            } catch (_) {}

            const calendar = new FullCalendar.Calendar(el, {
                initialView: 'dayGridMonth',     // ‰ªÖÊúàËßÜÂõæ
                height: 'auto',
                headerToolbar: {                 // Âè™ÊúâÂâçÂêéÁøªÈ°µ‰∏éÊ†áÈ¢ò
                    left: 'prev,next',
                    center: 'title',
                    right: ''
                },
                navLinks: false,
                nowIndicator: false,
                displayEventTime: false,
                dayMaxEventRows: 3,
                events,
                eventDidMount: (info) => {
                    // ËΩªÈáèÈÖçËâ≤ÔºàÂèØÈÄâÔºâ
                    const s = info.event.extendedProps.status?.toLowerCase();
                    info.el.style.border = '0';
                    if (s === 'confirmed') info.el.style.backgroundColor = '#e6f7ed';
                    else if (s === 'pending') info.el.style.backgroundColor = '#fff7e6';
                    else info.el.style.backgroundColor = '#eef2f6';
                },
                // ‰∏çÂÅöÁÇπÂáªË∑≥ËΩ¨Ôºå‰øùÊåÅÁ∫ØÊü•Áúã
                eventClick: null
            });

            calendar.render();
        });
    </script>

</div>

<div layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function loadKpis() {
            try {
                const res = await fetch('/lecturer/dashboard/kpis', {
                    cache: 'no-store',
                    credentials: 'same-origin'
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();

                // Â¶ÇÊûúÈ°µÈù¢‰∏äÊ≤°ÊúâËøô‰∫õÂÖÉÁ¥†Ôºå‰πü‰∏ç‰ºöÊä•ÈîôÔºõ‰øùÁïôÂéüÈÄªËæë‰ª•ÂÖºÂÆπ‰Ω†‰πãÂâçÁöÑÂÆûÁé∞
                const ids = ['kpiLogbook','kpiStudents','kpiSchedule','kpiEval'];
                const vals = [data.pendingLogbook ?? 0, data.students ?? 0, data.unvisitedSchedules ?? 0, data.pendingEvaluations ?? 0];
                ids.forEach((id, i) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = vals[i];
                });
                console.log('KPIs loaded:', data);
            } catch (e) {
                console.error('Failed to load KPIs:', e);
            }
        }
        document.addEventListener('DOMContentLoaded', loadKpis);
    </script>
</div>

</body>
</html>
