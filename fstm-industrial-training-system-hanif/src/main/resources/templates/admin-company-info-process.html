<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Process Company Submission</title>
</head>
<body>
<section layout:fragment="content">
    <div class="container mt-4">
        <h2 class="mb-3">
            <i class="bi bi-building-check"></i>
            Process Company Submission
        </h2>

        <!-- Basic info from CompanyInfo -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title" th:text="${info.companyName}">Company Name</h5>

                <p class="mb-1">
                    <strong>Student:</strong>
                    <span th:if="${student != null}"
                          th:text="${student.name}">Student Name</span>
                    <span th:if="${student == null}">Unknown Student</span>
                </p>

                <p class="mb-1">
                    <strong>Matric No.:</strong>
                    <span th:if="${student != null and student.studentId != null}"
                          th:text="${student.studentId}">A12345</span>
                    <span th:if="${student == null or student.studentId == null}">-</span>
                </p>

                <p class="mb-1">
                    <strong>Address:</strong>
                    <span th:text="${info.address}">Address</span>
                </p>
                <p class="mb-1">
                    <strong>Supervisor Name:</strong>
                    <span th:text="${info.supervisorName}">Supervisor</span>
                </p>
                <p class="mb-1">
                    <strong>Supervisor Email:</strong>
                    <span th:text="${info.supervisorEmail}">email@example.com</span>
                </p>
                <p class="mb-0">
                    <strong>Status:</strong>
                    <span class="badge bg-warning text-dark"
                          th:if="${info.status.name() == 'PENDING'}"
                          th:text="${info.status}">PENDING</span>

                    <span class="badge bg-success"
                          th:if="${info.status.name() == 'VERIFIED'}"
                          th:text="${info.status}">VERIFIED</span>

                    <span class="badge bg-danger"
                          th:if="${info.status.name() == 'REJECTED'}"
                          th:text="${info.status}">REJECTED</span>

                    <span class="badge bg-secondary"
                          th:if="${info.status.name() != 'PENDING'
                         and info.status.name() != 'VERIFIED'
                         and info.status.name() != 'REJECTED'}"
                          th:text="${info.status}">
                UNKNOWN
            </span>
                </p>
            </div>
        </div>


        <!-- If there is already a placement, show quick summary -->
        <div class="alert alert-info mb-3" th:if="${placement != null}">
            Existing placement for this Student.
            Status <strong th:text="${placement.status}">AWAITING_SUPERVISOR</strong>.
            Updating this form will update that placement.
        </div>

        <!-- MAIN FORM -->
        <form th:action="@{'/admin/company-info/' + ${info.id} + '/process'}"
              method="post" class="card">
            <div class="card-body">

                <!-- ======================== -->
                <!-- 1. COMPANY SECTION       -->
                <!-- ======================== -->
                <h5 class="mb-3">Company</h5>

                <!-- mode radios -->
                <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input"
                               type="radio"
                               name="companyMode"
                               id="companyModeExisting"
                               value="existing"
                               th:checked="${info.linkedCompanyId != null}">
                        <label class="form-check-label" for="companyModeExisting">
                            Use existing company
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input"
                               type="radio"
                               name="companyMode"
                               id="companyModeNew"
                               value="new"
                               th:checked="${info.linkedCompanyId == null}">
                        <label class="form-check-label" for="companyModeNew">
                            Create new company
                        </label>
                    </div>
                </div>

                <!-- existing company dropdown -->
                <div class="mb-3" id="existingCompanyBlock">
                    <label class="form-label fw-semibold">Link to Master Company</label>
                    <select class="form-select" name="existingCompanyId">
                        <option value="">-- Select company --</option>
                        <option th:each="c : ${companies}"
                                th:value="${c.id}"
                                th:selected="${info.linkedCompanyId != null} ? ${c.id} == ${info.linkedCompanyId} : false"
                                th:text="${c.name}">
                            Company
                        </option>
                    </select>
                    <div class="form-text">
                        Choose an existing company from the master list.
                    </div>
                </div>

                <!-- new company fields -->
                <div class="border rounded p-3 mb-3 bg-light" id="newCompanyBlock">
                    <div class="mb-2">
                        <label class="form-label fw-semibold">New company name</label>
                        <input type="text" class="form-control"
                               name="newCompanyName"
                               th:placeholder="${info.companyName}"
                               th:value="${info.companyName}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label fw-semibold">Address (optional)</label>
                        <input type="text" class="form-control"
                               name="newCompanyAddress"
                               th:placeholder="${info.address}"
                               th:value="${info.address}">
                    </div>
                    <div class="mb-0">
                        <label class="form-label fw-semibold">Sector (optional)</label>
                        <select class="form-select" name="newCompanySector">
                            <option value="">-- Select sector --</option>
                            <option th:each="s : ${sectorOptions}"
                                    th:value="${s.name()}"
                                    th:text="${s.name()}"></option>
                        </select>
                    </div>
                </div>

                <hr class="my-4"/>

                <!-- ======================== -->
                <!-- 2. SUPERVISOR SECTION    -->
                <!-- ======================== -->
                <h5 class="mb-3">Industry Supervisor</h5>

                <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input"
                               type="radio"
                               name="supervisorMode"
                               id="supModeExisting"
                               value="existing"
                               checked>
                        <label class="form-check-label" for="supModeExisting">
                            Use existing supervisor account
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input"
                               type="radio"
                               name="supervisorMode"
                               id="supModeNew"
                               value="new">
                        <label class="form-check-label" for="supModeNew">
                            Create new supervisor account
                        </label>
                    </div>
                </div>

                <!-- existing supervisor dropdown -->
                <div class="mb-3" id="existingSupervisorBlock">
                    <label class="form-label fw-semibold">Industry Supervisor (existing account)</label>
                    <select class="form-select" name="existingSupervisorId">
                        <option value="">-- Select supervisor --</option>
                        <option th:each="s : ${supervisors}"
                                th:value="${s.id}"
                                th:text="${s.name != null ? s.name + ' (' + s.username + ')' : s.username}">
                            Supervisor
                        </option>
                    </select>
                    <div class="form-text">
                        Pick the industry supervisor user account responsible for this student.
                    </div>
                </div>

                <!-- new supervisor fields -->
                <div class="border rounded p-3 mb-3 bg-light" id="newSupervisorBlock">
                    <div class="mb-2">
                        <label class="form-label fw-semibold">Supervisor name</label>
                        <input type="text" class="form-control"
                               name="supervisorName"
                               th:placeholder="${info.supervisorName}"
                               th:value="${info.supervisorName}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label fw-semibold">Supervisor email / username</label>
                        <input type="email" class="form-control"
                               name="supervisorUsername"
                               th:placeholder="${info.supervisorEmail}"
                               th:value="${info.supervisorEmail}">
                        <div class="form-text">
                            This will be used as the login username.
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label fw-semibold">Temporary password (optional)</label>
                        <input type="text" class="form-control"
                               name="supervisorPassword"
                               placeholder="Leave blank to auto-generate a strong password">
                    </div>
                    <div class="mb-0">
                        <label class="form-label fw-semibold">Supervisor phone (optional)</label>
                        <input type="text" class="form-control"
                               name="supervisorPhone"
                               th:value="${info.supervisorPhone}">
                    </div>
                </div>

                <hr class="my-4"/>

                <!-- ======================== -->
                <!-- 3. OTHER FIELDS          -->
                <!-- ======================== -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Session (optional)</label>
                    <input type="text" class="form-control"
                           name="session"
                           placeholder="e.g. 2025/2026-1"
                           th:value="${info.session}">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Placement Notes / Job Scope (optional)</label>
                    <textarea class="form-control" name="placementNotes" rows="3"
                              placeholder="Short description of job scope or notes for supervisor"
                              th:text="${info.jobScope}"></textarea>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox"
                           id="publicListingCheck"
                           name="publicListing"
                           th:checked="${info.isPublicListing != null} ? ${info.isPublicListing} : false">
                    <label class="form-check-label" for="publicListingCheck">
                        Show this company in public listing for future students
                    </label>
                </div>

                <!-- ======================== -->
                <!-- 4. SAVE ACTION           -->
                <!-- ======================== -->
                <div class="d-flex justify-content-between">
                    <a th:href="@{/admin/company-info(status=${info.status})}"
                       class="btn btn-outline-secondary">
                        Back to Submissions
                    </a>
                    <button type="submit" class="btn btn-primary">
                        Save &amp; Create / Update Placement
                    </button>
                </div>
            </div>
        </form>

        <!-- ======================== -->
        <!-- 5. VERIFY / REJECT PANEL -->
        <!-- ======================== -->
        <div class="card mt-3">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">Final Decision</h6>
                    <p class="mb-0 small text-muted">
                        After reviewing and saving, verify or reject this company submission.
                    </p>
                </div>
                <div>
                    <!-- Only show buttons when status is PENDING -->
                    <form th:if="${info.status.name() == 'PENDING'}"
                          th:action="@{/admin/company-info/{id}/verify(id=${info.id})}"
                          method="post"
                          class="d-inline">
                        <button type="submit" class="btn btn-success btn-sm">
                            Verify
                        </button>
                    </form>

                    <form th:if="${info.status.name() == 'PENDING'}"
                          th:action="@{/admin/company-info/{id}/reject(id=${info.id})}"
                          method="post"
                          class="d-inline ms-1">
                        <button type="submit" class="btn btn-danger btn-sm">
                            Reject
                        </button>
                    </form>

                    <!-- If already decided, just show badge -->
                    <span th:if="${info.status.name() == 'VERIFIED'}"
                          class="badge bg-success">
                        Already VERIFIED
                    </span>
                    <span th:if="${info.status.name() == 'REJECTED'}"
                          class="badge bg-danger">
                        Already REJECTED
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple JS to toggle blocks -->
    <script>
        (function () {
            function toggleCompany() {
                var existing = document.getElementById('companyModeExisting').checked;
                document.getElementById('existingCompanyBlock').style.display = existing ? 'block' : 'none';
                document.getElementById('newCompanyBlock').style.display = existing ? 'none' : 'block';
            }

            function toggleSupervisor() {
                var existing = document.getElementById('supModeExisting').checked;
                document.getElementById('existingSupervisorBlock').style.display = existing ? 'block' : 'none';
                document.getElementById('newSupervisorBlock').style.display = existing ? 'none' : 'block';
            }

            document.getElementById('companyModeExisting').addEventListener('change', toggleCompany);
            document.getElementById('companyModeNew').addEventListener('change', toggleCompany);
            document.getElementById('supModeExisting').addEventListener('change', toggleSupervisor);
            document.getElementById('supModeNew').addEventListener('change', toggleSupervisor);

            // initial state
            toggleCompany();
            toggleSupervisor();
        })();
    </script>
</section>
</body>
</html>
