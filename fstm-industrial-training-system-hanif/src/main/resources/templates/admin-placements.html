<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Placements</title>
</head>
<body>
<section layout:fragment="content" class="container mt-4">

    <h3 class="mb-1">Placements</h3>
    <p class="text-muted mb-3">
        This page shows all student placements and their current status.
    </p>

    <!-- Top bar: filter + new placement button -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <form class="d-flex align-items-center gap-2"
              th:action="@{/admin/placements}" method="get">
            <label class="form-label mb-0 me-2 fw-semibold" for="statusSelect">Status</label>
            <select id="statusSelect"
                    name="status"
                    class="form-select form-select-sm"
                    style="min-width: 180px;">
                <option value=""
                        th:selected="${status == null}">All</option>

                <option th:each="st : ${T(com.example.itsystem.model.PlacementStatus).values()}"
                        th:value="${st.name()}"
                        th:selected="${status != null and status.name() == st.name()}"
                        th:text="${st.name()}">
                </option>
            </select>

            <button type="submit" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-funnel"></i> Filter
            </button>
        </form>

        <a class="btn btn-sm btn-primary"
           th:href="@{/admin/placements/new}">
            <i class="bi bi-plus-lg"></i> New Placement
        </a>
    </div>

    <!-- Main table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                <tr>
                    <th style="width: 4%;">#</th>
                    <th style="width: 22%;">Student</th>
                    <th style="width: 20%;">Supervisor</th>
                    <th style="width: 20%;">Company</th>
                    <th style="width: 10%;">Start</th>
                    <th style="width: 10%;">End</th>
                    <th style="width: 10%;">Status</th>
                    <th style="width: 14%;">Action</th>
                </tr>
                </thead>
                <tbody>

                <!-- Empty state -->
                <tr th:if="${placements == null || placements.totalElements == 0}">
                    <td colspan="8" class="text-center text-muted py-4">
                        No placements found.
                    </td>
                </tr>

                <!-- Rows -->
                <tr th:each="p, stat : ${placements.content}">
                    <!-- running row number -->
                    <td th:text="${placements.number * placements.size + stat.index + 1}">1</td>

                    <!-- Student: name + matric -->
                    <td>
                        <span class="fw-bold"
                              th:text="${userById[p.studentId] != null
                                        ? userById[p.studentId].name
                                        : 'Unknown Student'}">
                            Student Name
                        </span>
                        <br/>
                        <small class="text-muted"
                               th:text="${userById[p.studentId] != null
                                         && userById[p.studentId].studentId != null
                                         ? 'Matric: ' + userById[p.studentId].studentId
                                         : 'Matric: -'}">
                            Matric: -
                        </small>
                    </td>

                    <!-- Supervisor -->
                    <td>
                        <span th:text="${userById[p.supervisorUserId] != null
                                        ? userById[p.supervisorUserId].name
                                        : '-'}">
                            Supervisor Name
                        </span>
                    </td>

                    <!-- Company -->
                    <td>
                        <span th:text="${companyById[p.companyId] != null
                                        ? companyById[p.companyId].name
                                        : '-'}">
                            Company Name
                        </span>
                    </td>

                    <!-- Start date -->
                    <td th:text="${p.startDate != null
                                  ? #temporals.format(p.startDate, 'dd/MM/yyyy')
                                  : '-'}">
                        -
                    </td>

                    <!-- End date -->
                    <td th:text="${p.endDate != null
                                  ? #temporals.format(p.endDate, 'dd/MM/yyyy')
                                  : '-'}">
                        -
                    </td>

                    <!-- Status badge -->
                    <td>
                        <span th:if="${p.status != null && p.status.name() == 'AWAITING_ADMIN'}"
                              class="badge bg-warning text-dark">
                            AWAITING_ADMIN
                        </span>
                        <span th:if="${p.status != null && p.status.name() == 'AWAITING_SUPERVISOR'}"
                              class="badge bg-info text-dark">
                            AWAITING_SUPERVISOR
                        </span>
                        <span th:if="${p.status != null && p.status.name() == 'APPROVED'}"
                              class="badge bg-success">
                            APPROVED
                        </span>
                        <span th:if="${p.status == null
                                      || (p.status.name() != 'AWAITING_ADMIN'
                                          && p.status.name() != 'AWAITING_SUPERVISOR'
                                          && p.status.name() != 'APPROVED')}"
                              class="badge bg-secondary"
                              th:text="${p.status}">UNKNOWN</span>
                    </td>

                    <!-- Actions -->
                    <td>
                        <div class="d-flex gap-2">
                            <!-- Approve button only when waiting for admin -->
                            <form th:if="${p.status != null && p.status.name() == 'AWAITING_ADMIN'}"
                                  th:action="@{/admin/placements/{id}/approve(id=${p.id})}"
                                  method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-success">
                                    Approve
                                </button>
                            </form>

                            <!-- View button: opens modal -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary"
                                    data-bs-toggle="modal"
                                    th:attr="data-bs-target=${'#placementModal-' + p.id}">
                                View
                            </button>

                            <!-- Delete button -->
                            <form th:action="@{/admin/placements/{id}/delete(id=${p.id})}"
                                  method="post"
                                  class="d-inline"
                                  onsubmit="return confirm('Are you sure you want to delete this placement?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    Delete
                                </button>
                            </form>
                        </div>

                        <!-- Modal for this placement -->
                        <div class="modal fade"
                             th:id="${'placementModal-' + p.id}"
                             tabindex="-1"
                             aria-hidden="true">
                            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            Placement Details
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>

                                    <div class="modal-body">
                                        <!-- Student info -->
                                        <h6 class="mb-1">Student</h6>
                                        <p class="mb-2">
                                            <strong th:text="${userById[p.studentId] != null
                                                              ? userById[p.studentId].name
                                                              : 'Unknown Student'}">
                                                Student Name
                                            </strong><br/>
                                            <span class="text-muted small">
                                                Matric:
                                                <span th:text="${userById[p.studentId] != null
                                                                && userById[p.studentId].studentId != null
                                                                ? userById[p.studentId].studentId
                                                                : '-'}">-</span>
                                            </span>
                                        </p>

                                        <!-- Supervisor info -->
                                        <h6 class="mb-1">Industry Supervisor</h6>
                                        <p class="mb-2">
                                            <span th:text="${userById[p.supervisorUserId] != null
                                                            ? userById[p.supervisorUserId].name
                                                            : '-'}">
                                                Supervisor Name
                                            </span>
                                        </p>

                                        <!-- Company info -->
                                        <h6 class="mb-1">Company</h6>
                                        <p class="mb-2">
                                            <span th:text="${companyById[p.companyId] != null
                                                            ? companyById[p.companyId].name
                                                            : '-'}">
                                                Company Name
                                            </span>
                                        </p>

                                        <!-- Internship details -->
                                        <h6 class="mb-1">Internship Details</h6>
                                        <dl class="row mb-0">
                                            <dt class="col-sm-4">Start Date</dt>
                                            <dd class="col-sm-8"
                                                th:text="${p.startDate != null
                                                          ? #temporals.format(p.startDate, 'dd/MM/yyyy')
                                                          : '-'}">-</dd>

                                            <dt class="col-sm-4">End Date</dt>
                                            <dd class="col-sm-8"
                                                th:text="${p.endDate != null
                                                          ? #temporals.format(p.endDate, 'dd/MM/yyyy')
                                                          : '-'}">-</dd>

                                            <dt class="col-sm-4">Report Duty Date</dt>
                                            <dd class="col-sm-8"
                                                th:text="${p.reportDutyDate != null
                                                          ? #temporals.format(p.reportDutyDate, 'dd/MM/yyyy')
                                                          : '-'}">-</dd>

                                            <dt class="col-sm-4">Department</dt>
                                            <dd class="col-sm-8"
                                                th:text="${p.department != null ? p.department : '-'}">-</dd>

                                            <dt class="col-sm-4">Job Scope</dt>
                                            <dd class="col-sm-8"
                                                th:text="${p.jobScope != null ? p.jobScope : '-'}">-</dd>

                                            <dt class="col-sm-4">Allowance</dt>
                                            <dd class="col-sm-8"
                                                th:text="${p.allowance != null ? p.allowance : '-'}">-</dd>

                                            <dt class="col-sm-4">Accommodation</dt>
                                            <dd class="col-sm-8"
                                                th:text="${p.accommodation} ? 'Provided' : 'Not provided'">
                                                Not provided
                                            </dd>

                                            <dt class="col-sm-4">Status</dt>
                                            <dd class="col-sm-8"
                                                th:text="${p.status != null ? p.status.name() : '-'}">-</dd>
                                        </dl>
                                    </div>

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                                data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /Modal -->
                    </td>
                </tr>

                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="card-footer d-flex justify-content-between align-items-center">
            <div class="text-muted small">
                <span th:text="'Showing ' + ${placements.number + 1} + ' / ' + ${placements.totalPages} + ' page(s).'">
                    Showing 1 / 1 page(s).
                </span>
                <span th:if="${placements.totalElements > 0}">
                    &nbsp; Total placements:
                    <span th:text="${placements.totalElements}">0</span>
                </span>
            </div>

            <nav th:if="${placements.totalPages > 1}">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" th:classappend="${placements.first} ? ' disabled'">
                        <a class="page-link"
                           th:href="@{/admin/placements(page=${placements.number - 1}, status=${status})}">
                            &laquo;
                        </a>
                    </li>

                    <li class="page-item"
                        th:each="pIdx : ${#numbers.sequence(0, placements.totalPages - 1)}"
                        th:classappend="${pIdx == placements.number} ? ' active'">
                        <a class="page-link"
                           th:text="${pIdx + 1}"
                           th:href="@{/admin/placements(page=${pIdx}, status=${status})}">
                            1
                        </a>
                    </li>

                    <li class="page-item" th:classappend="${placements.last} ? ' disabled'">
                        <a class="page-link"
                           th:href="@{/admin/placements(page=${placements.number + 1}, status=${status})}">
                            &raquo;
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

</section>
</body>
</html>
