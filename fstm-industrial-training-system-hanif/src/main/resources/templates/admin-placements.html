<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Placements • UPM Industrial Training</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap + Icons + Font -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- your global css -->
    <link th:href="@{/app.css}" rel="stylesheet">

    <style>
        :root{
            --border: rgba(148,163,184,.25);
            --muted:#64748b;
            --ink:#0f172a;
            --bg:#f5f7fa;
        }
        body{
            font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
            background:var(--bg);
            color:var(--ink);
        }
        .container-narrow{ max-width:1240px; }

        .pill{
            display:inline-flex; gap:8px; align-items:center;
            padding:6px 12px; border-radius:999px;
            background:#eef2ff; color:#1e40af;
            font-size:.85rem; font-weight:800;
        }
        .page-title{ letter-spacing:-0.2px; }
        .muted{ color:var(--muted); }
        .btn-rounded{ border-radius:12px; padding:.6rem .95rem; }
        .btn-sm.btn-rounded{ padding:.45rem .7rem; border-radius:10px; }

        .card-soft{
            background:#fff;
            border:1px solid var(--border);
            border-radius:18px;
            box-shadow:0 12px 30px rgba(15,23,42,.10);
        }

        .table thead th{
            background:#fff;
            border-bottom:1px solid var(--border);
            font-weight:800;
            color:#334155;
            font-size:.9rem;
            white-space:nowrap;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .table tbody td{ vertical-align:middle; }
        .table-responsive{ max-height:66vh; overflow:auto; }
        .col-narrow{ width:1%; white-space:nowrap; }

        .status-badge{
            border-radius:999px;
            padding:.4rem .7rem;
            font-weight:900;
            font-size:.72rem;
            letter-spacing:.04em;
            border:1px solid transparent;
            display:inline-block;
            white-space:nowrap;
        }
        .st-admin{ background:rgba(245,158,11,.18); color:#92400e; border-color:rgba(245,158,11,.25); }
        .st-sup{ background:rgba(56,189,248,.18); color:#0c4a6e; border-color:rgba(56,189,248,.25); }
        .st-approved{ background:rgba(34,197,94,.15); color:#166534; border-color:rgba(34,197,94,.22); }
        .st-other{ background:#eef2f7; color:#475569; border-color:rgba(71,85,105,.18); }

        .filterbar{
            display:flex; flex-wrap:wrap; align-items:end; justify-content:space-between;
            gap:12px;
        }
    </style>
</head>

<body>

<!-- Navbar (match dashboard) -->
<nav class="navbar navbar-expand-lg appbar">
    <div class="container container-narrow">
        <a class="navbar-brand d-flex align-items-center gap-2" th:href="@{/admin/dashboard}">
            <img th:src="@{/Picture1.png}" alt="UPM" style="height:28px">
            <span>Admin Panel • UPM Industrial Training</span>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navAdminPlacements">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div id="navAdminPlacements" class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a th:href="@{/admin/students}" class="nav-link">Students</a></li>
                <li class="nav-item"><a th:href="@{/admin/lecturers}" class="nav-link">Lecturers</a></li>
                <li class="nav-item"><a th:href="@{/admin/evaluations}" class="nav-link">Evaluations</a></li>
                <li class="nav-item"><a th:href="@{/admin/companies}" class="nav-link">Companies</a></li>
                <li class="nav-item"><a th:href="@{/admin/company-master}" class="nav-link">Company Master</a></li>
                <li class="nav-item"><a th:href="@{/admin/company-info(status='PENDING')}" class="nav-link">Submissions</a></li>
                <li class="nav-item"><a th:href="@{/admin/placements}" class="nav-link active">Placements</a></li>
                <li class="nav-item"><a th:href="@{/logout}" class="nav-link">Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<main class="container container-narrow py-4">

    <!-- Header -->
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
            <span class="pill"><i class="bi bi-diagram-3"></i> Placements</span>
            <h1 class="h4 page-title mb-0 mt-2">Student Placements</h1>
            <div class="muted mt-1">Review, approve, and monitor internship placements.</div>
        </div>
    </div>

    <!-- Top bar -->
    <div class="filterbar mb-3">
        <form class="d-flex flex-wrap align-items-end gap-2"
              th:action="@{/admin/placements}" method="get">
            <div>
                <label class="form-label mb-1 fw-semibold" for="statusSelect">Status</label>
                <select id="statusSelect"
                        name="status"
                        class="form-select"
                        style="min-width: 220px;">
                    <option value="" th:selected="${status == null}">All</option>

                    <option th:each="st : ${T(com.example.itsystem.model.PlacementStatus).values()}"
                            th:value="${st.name()}"
                            th:selected="${status != null and status.name() == st.name()}"
                            th:text="${st.name()}">
                    </option>
                </select>
            </div>

            <button type="submit" class="btn btn-outline-primary btn-rounded">
                <i class="bi bi-funnel me-1"></i> Filter
            </button>
        </form>

        <a class="btn btn-primary btn-rounded" th:href="@{/admin/placements/new}">
            <i class="bi bi-plus-lg me-1"></i> New Placement
        </a>
    </div>

    <!-- Table -->
    <div class="card-soft overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle bg-white">
                <thead>
                <tr>
                    <th class="col-narrow">#</th>
                    <th style="min-width:240px;">Student</th>
                    <th style="min-width:200px;">Supervisor</th>
                    <th style="min-width:220px;">Company</th>
                    <th class="col-narrow">Start</th>
                    <th class="col-narrow">End</th>
                    <th class="col-narrow">Status</th>
                    <th class="col-narrow">Action</th>
                </tr>
                </thead>

                <tbody>
                <tr th:if="${placements == null || placements.totalElements == 0}">
                    <td colspan="8" class="text-center text-muted py-5">
                        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                        No placements found.
                    </td>
                </tr>

                <tr th:each="p, stat : ${placements.content}">
                    <td class="col-narrow" th:text="${placements.number * placements.size + stat.index + 1}">1</td>

                    <td>
                        <div class="fw-semibold"
                             th:text="${userById[p.studentId] != null ? userById[p.studentId].name : 'Unknown Student'}">
                            Student Name
                        </div>
                        <div class="muted small">
              <span th:text="${userById[p.studentId] != null && userById[p.studentId].studentId != null
                              ? 'Matric: ' + userById[p.studentId].studentId
                              : 'Matric: -'}">Matric: -</span>
                        </div>
                    </td>

                    <td>
                        <span th:text="${userById[p.supervisorUserId] != null ? userById[p.supervisorUserId].name : '-'}">-</span>
                    </td>

                    <td>
                        <span th:text="${companyById[p.companyId] != null ? companyById[p.companyId].name : '-'}">-</span>
                    </td>

                    <td class="col-narrow"
                        th:text="${p.startDate != null ? #temporals.format(p.startDate, 'dd/MM/yyyy') : '-'}">-</td>

                    <td class="col-narrow"
                        th:text="${p.endDate != null ? #temporals.format(p.endDate, 'dd/MM/yyyy') : '-'}">-</td>

                    <td class="col-narrow">
            <span th:if="${p.status != null && p.status.name() == 'AWAITING_ADMIN'}" class="status-badge st-admin">
              AWAITING_ADMIN
            </span>
                        <span th:if="${p.status != null && p.status.name() == 'AWAITING_SUPERVISOR'}" class="status-badge st-sup">
              AWAITING_SUPERVISOR
            </span>
                        <span th:if="${p.status != null && p.status.name() == 'APPROVED'}" class="status-badge st-approved">
              APPROVED
            </span>
                        <span th:if="${p.status == null
                          || (p.status.name() != 'AWAITING_ADMIN'
                              && p.status.name() != 'AWAITING_SUPERVISOR'
                              && p.status.name() != 'APPROVED')}"
                              class="status-badge st-other"
                              th:text="${p.status}">UNKNOWN</span>
                    </td>

                    <td class="col-narrow">
                        <div class="d-flex gap-2 flex-wrap">
                            <!-- Approve only when waiting for admin -->
                            <form th:if="${p.status != null && p.status.name() == 'AWAITING_ADMIN'}"
                                  th:action="@{/admin/placements/{id}/approve(id=${p.id})}"
                                  method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-success btn-rounded">
                                    <i class="bi bi-check2-circle me-1"></i> Approve
                                </button>
                            </form>

                            <!-- View -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary btn-rounded"
                                    data-bs-toggle="modal"
                                    th:attr="data-bs-target=${'#placementModal-' + p.id}">
                                <i class="bi bi-eye me-1"></i> View
                            </button>

                            <!-- Delete -->
                            <form th:action="@{/admin/placements/{id}/delete(id=${p.id})}"
                                  method="post"
                                  class="d-inline"
                                  onsubmit="return confirm('Are you sure you want to delete this placement?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger btn-rounded">
                                    <i class="bi bi-trash3 me-1"></i> Delete
                                </button>
                            </form>
                        </div>

                        <!-- Modal -->
                        <div class="modal fade"
                             th:id="${'placementModal-' + p.id}"
                             tabindex="-1"
                             aria-hidden="true">
                            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                <div class="modal-content" style="border-radius:16px;">
                                    <div class="modal-header">
                                        <h5 class="modal-title fw-bold">Placement Details</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>

                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <div class="muted small fw-semibold mb-1">Student</div>
                                            <div class="fw-semibold"
                                                 th:text="${userById[p.studentId] != null ? userById[p.studentId].name : 'Unknown Student'}">
                                                Student Name
                                            </div>
                                            <div class="muted small">
                                                Matric:
                                                <span th:text="${userById[p.studentId] != null && userById[p.studentId].studentId != null
                                        ? userById[p.studentId].studentId : '-'}">-</span>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="muted small fw-semibold mb-1">Industry Supervisor</div>
                                            <div th:text="${userById[p.supervisorUserId] != null ? userById[p.supervisorUserId].name : '-'}">-</div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="muted small fw-semibold mb-1">Company</div>
                                            <div th:text="${companyById[p.companyId] != null ? companyById[p.companyId].name : '-'}">-</div>
                                        </div>

                                        <div class="mb-2">
                                            <div class="muted small fw-semibold mb-1">Internship Details</div>
                                            <dl class="row mb-0">
                                                <dt class="col-sm-4">Start Date</dt>
                                                <dd class="col-sm-8" th:text="${p.startDate != null ? #temporals.format(p.startDate, 'dd/MM/yyyy') : '-'}">-</dd>

                                                <dt class="col-sm-4">End Date</dt>
                                                <dd class="col-sm-8" th:text="${p.endDate != null ? #temporals.format(p.endDate, 'dd/MM/yyyy') : '-'}">-</dd>

                                                <dt class="col-sm-4">Report Duty Date</dt>
                                                <dd class="col-sm-8" th:text="${p.reportDutyDate != null ? #temporals.format(p.reportDutyDate, 'dd/MM/yyyy') : '-'}">-</dd>

                                                <dt class="col-sm-4">Department</dt>
                                                <dd class="col-sm-8" th:text="${p.department != null ? p.department : '-'}">-</dd>

                                                <dt class="col-sm-4">Job Scope</dt>
                                                <dd class="col-sm-8" th:text="${p.jobScope != null ? p.jobScope : '-'}">-</dd>

                                                <dt class="col-sm-4">Allowance</dt>
                                                <dd class="col-sm-8" th:text="${p.allowance != null ? p.allowance : '-'}">-</dd>

                                                <dt class="col-sm-4">Accommodation</dt>
                                                <dd class="col-sm-8" th:text="${p.accommodation} ? 'Provided' : 'Not provided'">Not provided</dd>

                                                <dt class="col-sm-4">Status</dt>
                                                <dd class="col-sm-8" th:text="${p.status != null ? p.status.name() : '-'}">-</dd>
                                            </dl>
                                        </div>
                                    </div>

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary btn-rounded" data-bs-dismiss="modal">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /Modal -->

                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center p-3 border-top" style="border-color: var(--border) !important;">
            <div class="muted small">
                <span th:text="'Page ' + ${placements.number + 1} + ' of ' + ${placements.totalPages}">Page 1 of 1</span>
                <span th:if="${placements.totalElements > 0}">
          &nbsp;• Total placements: <span class="fw-semibold" th:text="${placements.totalElements}">0</span>
        </span>
            </div>

            <nav th:if="${placements.totalPages > 1}">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" th:classappend="${placements.first} ? ' disabled'">
                        <a class="page-link"
                           th:href="@{/admin/placements(page=${placements.number - 1}, status=${status})}">
                            &laquo;
                        </a>
                    </li>

                    <li class="page-item"
                        th:each="pIdx : ${#numbers.sequence(0, placements.totalPages - 1)}"
                        th:classappend="${pIdx == placements.number} ? ' active'">
                        <a class="page-link"
                           th:text="${pIdx + 1}"
                           th:href="@{/admin/placements(page=${pIdx}, status=${status})}">
                            1
                        </a>
                    </li>

                    <li class="page-item" th:classappend="${placements.last} ? ' disabled'">
                        <a class="page-link"
                           th:href="@{/admin/placements(page=${placements.number + 1}, status=${status})}">
                            &raquo;
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

</main>

<footer class="text-center text-muted py-4 small">
    © <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}">2025</span>, Faculty of Food Science and Technology, UPM
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
