<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>FSTM UPM Industrial Training - Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- (Optional) Your external overrides if you created /css/app.css -->
    <link th:href="@{/css/app.css}" rel="stylesheet" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Page-specific CSS -->
    <style>
        :root{
            --brand:#ec4e0a;
            --primary:#0d6efd;
            --bg:#f5f7fa;
            --text:#1f2937;
            --muted:#6b7280;
            --border:#e5e7eb;
            --radius:16px;
            --shadow:0 8px 18px rgba(0,0,0,.06);
        }

        html,body{ background:var(--bg); color:var(--text); }
        .container-narrow{ max-width:1240px; }

        /* Header */
        .header-bar{ background:var(--brand); color:#fff; padding:10px 0; }
        .header-brand img{ height:44px; width:auto; }
        .header-title{ font-weight:600; font-size:1.05rem; margin:0 0 0 .75rem; }

        /* Cards */
        .card{ border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }
        .card-title{ margin:0; font-weight:700; }

        /* Auth card */
        .auth-card{ max-width:360px; margin-inline:auto; overflow:hidden; }
        .brand-mark{ height:40px; width:auto; object-fit:contain; }

        /* Inputs & button rhythm */
        .auth-card .form-label{ margin-bottom:.35rem; }
        .auth-card .form-control{ height:40px; padding:.5rem .75rem; box-sizing:border-box; }
        .auth-card .btn-primary{ height:40px; border-radius:12px; margin:0; box-sizing:border-box; }

        /* Guaranteed spacing */
        .stack-12{ display:flex; flex-direction:column; gap:14px; }

        /* Chart sizing */
        .chart-wrap{ height:320px; }
        .chart-wrap canvas{ width:100%!important; height:100%!important; }

        /* Table wrapper */
        .table-wrap{ max-height:360px; overflow:auto; border:1px solid var(--border); border-radius:12px; }
        .table-wrap thead th{ position:sticky; top:0; background:#fff; z-index:1; }

        .subtle{ color:var(--muted); }

        /* Opportunities feed cards */
        .op-card { border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,.08); }
        .op-img { height:180px; object-fit:cover; border-top-left-radius:12px; border-top-right-radius:12px; }
        .badge { font-size:.72rem; }

        /* ---------- Partners (Premium) ---------- */
        .partners-wrap{ --tile-h: 72px; --tile-r: 14px; }

        .partners-grid{
            display:grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap:12px;
        }

        .partner-tile{
            height: var(--tile-h);
            border: 1px solid rgba(148,163,184,.25);
            border-radius: var(--tile-r);
            background: linear-gradient(180deg, rgba(255,255,255,.90), rgba(255,255,255,.72));
            box-shadow: 0 8px 18px rgba(15,23,42,.06);
            display:flex;
            align-items:center;
            justify-content:center;
            padding: 10px 14px;
            transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
            overflow:hidden;
            text-decoration:none;
        }

        .partner-tile:hover{
            transform: translateY(-2px);
            box-shadow: 0 14px 26px rgba(15,23,42,.10);
            border-color: rgba(13,110,253,.25);
        }
        .partner-tile:active{ transform: translateY(0px); }

        .partner-tile img{
            width:100%;
            height:100%;
            object-fit: contain;
            object-position:center;
            max-height: 44px;
            filter: grayscale(18%);
            opacity: .95;
            transition: filter .18s ease, opacity .18s ease, transform .18s ease;
        }

        .partner-tile:hover img{
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.02);
        }

        @media (max-width: 420px){
            .partners-wrap{ --tile-h: 66px; }
            .partner-tile img{ max-height: 40px; }
        }
    </style>
</head>

<body>

<!-- Top bar -->
<header class="header-bar">
    <div class="container container-narrow d-flex align-items-center">
        <div class="header-brand d-flex align-items-center">
            <img th:src="@{/Picture1.png}" alt="UPM Logo" />
            <h1 class="header-title">FSTM UPM Industrial Training and Career Management System</h1>
        </div>
    </div>
</header>

<main class="container container-narrow py-5">
    <div class="row g-4 align-items-start">

        <!-- Left: Login + partners -->
        <div class="col-lg-4">
            <div class="card p-4 auth-card">
                <div class="d-flex justify-content-center mb-2">
                    <img th:src="@{/Picture1.png}" alt="UPM" class="brand-mark" />
                </div>

                <h2 class="text-center mb-3">Login</h2>

                <!-- Error banner -->
                <div th:if="${param.error}" class="alert alert-danger py-2">
                    Invalid username, password, or role.
                </div>

                <!-- ✅ Access-window / account status messages -->
                <div th:if="${param.disabled}" class="alert alert-danger py-2">
                    Your account is disabled. Please contact the admin.
                </div>

                <div th:if="${param.notstarted}" class="alert alert-warning py-2">
                    Your access has not started yet. Please check the access window set by the admin.
                </div>

                <div th:if="${param.expired}" class="alert alert-danger py-2">
                    Your access has expired. Please contact the admin to renew your access.
                </div>

                <!-- ✅ Single form (fixed) -->
                <form th:action="@{/login}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <div class="mb-3">
                        <label for="username" class="form-label mb-1">UPM ID</label>
                        <input type="text" id="username" name="username" class="form-control"
                               placeholder="Enter UPM ID" required>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label mb-1">Password</label>
                        <input type="password" id="password" name="password" class="form-control"
                               placeholder="Enter password" required>
                    </div>

                    <div class="stack-12">
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </div>
                </form>
            </div>

            <!-- Partners (Premium, equal ratio + spacing) -->
            <div class="card p-3 mt-4 partners-wrap">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <span class="fw-semibold">Trusted by companies</span>
                    <span class="subtle small">Partnerships & internships</span>
                </div>

                <div class="partners-grid">
                    <a class="partner-tile" href="https://kfc.com.my/" target="_blank" rel="noopener">
                        <img src="/logos/KFC.png" alt="KFC">
                    </a>

                    <a class="partner-tile" href="https://www.mcdonalds.com.my/" target="_blank" rel="noopener">
                        <img src="/logos/MCD.png" alt="MCD">
                    </a>

                    <a class="partner-tile" href="http://www.mixuemalaysia.com/" target="_blank" rel="noopener">
                        <img src="/logos/MIXUE.png" alt="MIXUE">
                    </a>

                    <a class="partner-tile" href="https://chagee.com.my/" target="_blank" rel="noopener">
                        <img src="/logos/CHAGEE.png" alt="CHAGEE">
                    </a>

                    <a class="partner-tile" href="https://www.subway.com.my/" target="_blank" rel="noopener">
                        <img src="/logos/SUBWAY.png" alt="SUBWAY">
                    </a>

                    <a class="partner-tile" href="https://www.starbucks.com.my/" target="_blank" rel="noopener">
                        <img src="/logos/STARBUCKS.png" alt="STARBUCKS">
                    </a>
                </div>
            </div>
        </div>

        <!-- Right: Opportunities feed + Chart + Table -->
        <div class="col-lg-8">

            <!-- Opportunities Feed -->
            <div class="card p-3 mb-4">
                <div class="d-flex align-items-center justify-content-between">
                    <h3 class="card-title fs-5 mb-0">Latest Opportunities</h3>
                    <span class="subtle small">From industry partners</span>
                </div>

                <div id="op-feed" class="row g-3 mt-2"></div>

                <div class="text-center mt-3">
                    <button id="op-loadmore" class="btn btn-outline-primary btn-sm">Load more</button>
                </div>
            </div>

            <!-- Chart -->
            <div class="card p-3 mb-4">
                <div class="d-flex align-items-center justify-content-between">
                    <h3 class="card-title fs-5">Student Placement by Organisation Type</h3>
                    <span class="subtle small">Summary</span>
                </div>
                <div class="chart-wrap mt-2">
                    <canvas id="orgChart"></canvas>
                </div>
            </div>

            <!-- Table -->
            <div class="card p-3">
                <h3 class="card-title fs-5 mb-2">Registered Organisation Name & Student Count</h3>
                <input id="orgSearch" type="text" class="form-control mb-2" placeholder="Search organisation" />
                <div class="table-wrap">
                    <table class="table align-middle mb-0">
                        <thead>
                        <tr>
                            <th style="width:80px">No</th>
                            <th>Organisation Name</th>
                            <th style="width:100px">Total</th>
                        </tr>
                        </thead>
                        <tbody id="orgTableBody">
                        <tr th:if="${#lists.isEmpty(companyCounts)}">
                            <td colspan="3" class="text-center text-muted py-4">No company records found.</td>
                        </tr>

                        <tr th:each="r, stat : ${companyCounts}">
                            <td th:text="${stat.count}">1</td>
                            <td th:text="${r.companyName}">Company Name</td>
                            <td th:text="${r.totalStudents}">0</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</main>

<footer class="text-center text-muted py-4 small">
    © 2025, Faculty of Food Science and Technology, UPM
</footer>

<!-- Opportunities feed script -->
<script>
    let opPage = 0;
    const OP_SIZE = 3;      // show 3 per load (one row)
    let opLoading = false;
    let opLast = false;

    async function loadOpportunities() {
        if (opLoading || opLast) return;
        opLoading = true;

        try {
            const res = await fetch(`/api/opportunities?page=${opPage}&size=${OP_SIZE}`);
            if (!res.ok) throw new Error('Failed to load opportunities');
            const data = await res.json();

            const feed = document.getElementById('op-feed');

            data.content.forEach(p => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';

                const card = document.createElement('div');
                card.className = 'card h-100 op-card';

                if (p.imageUrl) {
                    const img = document.createElement('img');
                    img.className = 'card-img-top op-img';
                    img.src = p.imageUrl;
                    img.alt = 'Opportunity image';
                    card.appendChild(img);
                }

                const body = document.createElement('div');
                body.className = 'card-body d-flex flex-column';

                const h5 = document.createElement('h5');
                h5.className = 'card-title mb-1';
                h5.textContent = p.title || 'Opportunity';
                body.appendChild(h5);

                const company = document.createElement('div');
                company.className = 'text-muted small mb-2';
                company.textContent = p.companyName || '';
                body.appendChild(company);

                const badges = document.createElement('div');
                badges.className = 'mb-2';
                if (p.roleType) badges.innerHTML += `<span class="badge text-bg-primary me-1">${p.roleType}</span>`;
                if (p.workMode) badges.innerHTML += `<span class="badge text-bg-secondary me-1">${p.workMode}</span>`;
                if (p.location) badges.innerHTML += `<span class="badge text-bg-light text-dark">${p.location}</span>`;
                body.appendChild(badges);

                const desc = document.createElement('p');
                desc.className = 'card-text';
                const text = p.description || '';
                desc.textContent = text.length > 180 ? text.slice(0, 180) + '…' : text;
                body.appendChild(desc);

                const ul = document.createElement('ul');
                ul.className = 'list-unstyled small mb-3';
                ul.innerHTML =
                    `<li><strong>Contact:</strong> ${p.contactName ?? ''}</li>` +
                    `<li><strong>Email:</strong> ${p.contactEmail ?? ''}</li>` +
                    (p.contactPhone ? `<li><strong>Phone:</strong> ${p.contactPhone}</li>` : '') +
                    (p.deadline ? `<li><strong>Deadline:</strong> ${p.deadline}</li>` : '');
                body.appendChild(ul);

                const footer = document.createElement('div');
                footer.className = 'mt-auto';
                if (p.externalLink) {
                    const a = document.createElement('a');
                    a.className = 'btn btn-outline-primary';
                    a.href = p.externalLink;
                    a.target = '_blank';
                    a.textContent = 'Details / Apply';
                    footer.appendChild(a);
                }
                body.appendChild(footer);

                card.appendChild(body);
                col.appendChild(card);
                feed.appendChild(col);
            });

            // Update paging state
            opLast = data.last || (data.content?.length ?? 0) < OP_SIZE;
            opPage += 1;

            const btn = document.getElementById('op-loadmore');
            if (opLast) {
                btn.classList.add('disabled');
                btn.textContent = 'No more opportunities';
            } else {
                btn.classList.remove('disabled');
                btn.textContent = 'Load more';
            }
        } catch (e) {
            console.error(e);
        } finally {
            opLoading = false;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('op-loadmore')?.addEventListener('click', loadOpportunities);
        // Initial load: exactly one row (3 cards)
        loadOpportunities();
    });
</script>

<script th:inline="javascript">
    const labels = /*[[${sectorLabels}]]*/ [];
    const values = /*[[${sectorData}]]*/ [];

    const ctx = document.getElementById('orgChart');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Companies',
                data: values,
                backgroundColor: 'rgba(13, 110, 253, 0.7)'
            }]
        },
        options: {
            maintainAspectRatio: false,
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { position: 'top' } }
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('orgSearch');
        const tbody = document.getElementById('orgTableBody');
        if (!input || !tbody) return;

        input.addEventListener('input', () => {
            const q = input.value.toLowerCase().trim();
            [...tbody.querySelectorAll('tr')].forEach(tr => {
                const nameCell = tr.children[1];
                if (!nameCell) return;
                const txt = nameCell.textContent.toLowerCase();
                tr.style.display = txt.includes(q) ? '' : 'none';
            });
        });
    });
</script>

</body>
</html>