<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Students</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{ --border:#e5e7eb; --muted:#6b7280; }
    body{ background:#f5f7fa; }
    .container-narrow{ max-width:1240px; }

    /* Blue app bar */
    .appbar{ background:#0d6efd; color:#fff; }
    .appbar a{ color:#fff; text-decoration:none; }
    .appbar .nav-link{ color:#fff; opacity:.9; }
    .appbar .nav-link:hover{ opacity:1; text-decoration:underline; }

    /* Carded table */
    .table-card{ border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:0 8px 18px rgba(0,0,0,.06); }
    .table thead th{ background:#fff; position:sticky; top:0; z-index:2; border-bottom:1px solid var(--border); }
    .table tbody td{ vertical-align:middle; }
    .table-responsive{ max-height:64vh; overflow:auto; }
    .col-narrow{ width:1%; white-space:nowrap; }

    /* Status + access */
    .status-pill{ font-weight:700; letter-spacing:.02em; }
    .status-on{ background:#E6F4EA; color:#1F7A39; }
    .status-off{ background:#ECEEF3; color:#495057; }
    .access-meta{ color:var(--muted); font-size:.85rem; line-height:1.1; }
    .access-form .form-control{ height:34px; }
    .access-form .btn{ height:34px; }

    /* Actions */
    .action-group .btn{ width:36px; height:36px; padding:0; display:inline-flex; align-items:center; justify-content:center; }
    .action-group .btn i{ font-size:1rem; }

    /* Footer of table */
    .page-footer{ border-top:1px solid var(--border); }
  </style>
</head>
<body>

<!-- Header -->
<nav class="navbar navbar-expand-lg appbar">
  <div class="container container-narrow">
    <a class="navbar-brand d-flex align-items-center gap-2" th:href="@{/admin/dashboard}">
      <img th:src="@{/Picture1.png}" alt="UPM" style="height:26px">
      <span>Admin • Manage Students</span>
    </a>
    <div class="ms-auto">
      <a th:href="@{/admin/dashboard}" class="btn btn-outline-light btn-sm">
        <i class="bi bi-arrow-left"></i> Dashboard
      </a>
    </div>
  </div>
</nav>

<main class="container container-narrow py-4">

  <!-- Title / Actions -->
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <h1 class="h4 m-0">Students</h1>
    <div class="btn-group">
      <a th:href="@{/admin/students/add}" class="btn btn-success">
        <i class="bi bi-person-plus"></i> <span class="d-none d-sm-inline">Add New</span>
      </a>
      <a th:href="@{/admin/students/import}" class="btn btn-outline-success">
        <i class="bi bi-upload"></i> <span class="d-none d-sm-inline">Bulk Import</span>
      </a>
    </div>
  </div>

  <!-- Session filter + search + total -->
  <div class="row g-2 align-items-end mb-3">
    <div class="col-12 col-md-9">
      <form class="row g-2 align-items-end" method="get" th:action="@{/admin/students}">
        <!-- Session dropdown -->
        <div class="col-12 col-md-4">
          <label class="form-label mb-1">Session</label>
          <select class="form-select" name="session">
            <option value=""
                    th:selected="${selectedSession == null or selectedSession == ''}">
              All sessions
            </option>
            <option th:each="s : ${sessionOptions}"
                    th:value="${s}"
                    th:text="${s}"
                    th:selected="${s == selectedSession}"></option>
          </select>
        </div>

        <!-- Search box -->
        <div class="col-12 col-md-6">
          <label class="form-label mb-1">Search</label>
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input type="text"
                   name="search"
                   class="form-control"
                   placeholder="Search by name, student ID, company..."
                   th:value="${search}">
          </div>
        </div>

        <!-- Keep current page size -->
        <input type="hidden" name="size" th:value="${size}"/>

        <!-- Filter button -->
        <div class="col-6 col-md-2">
          <button class="btn btn-primary w-100" type="submit">
            Filter
          </button>
        </div>
      </form>
    </div>

    <!-- Total count -->
    <div class="col-12 col-md-3 text-md-end text-muted mt-2 mt-md-0">
      <small>
        Total Students:
        <span class="fw-semibold" th:text="${students.totalElements}">0</span>
      </small>
    </div>
  </div>

  <!-- Table + bulk actions -->
  <div class="table-card bg-white">

    <!-- Bulk action toolbar -->
    <form th:action="@{/admin/students/bulk}" method="post" id="bulkForm" class="px-3 pt-3 pb-2">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="selectAll">
          <label class="form-check-label" for="selectAll">
            Select all students on this page
          </label>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <!-- Access window inputs for bulk window update -->
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text">Start</span>
            <input type="date" class="form-control" name="start">
            <span class="input-group-text">End</span>
            <input type="date" class="form-control" name="end">
          </div>

          <!-- Bulk action buttons -->
          <div class="btn-group btn-group-sm" role="group">
            <button type="button"
                    class="btn btn-outline-success"
                    onclick="submitBulk('status', true)">
              Enable
            </button>
            <button type="button"
                    class="btn btn-outline-secondary"
                    onclick="submitBulk('status', false)">
              Disable
            </button>
            <button type="button"
                    class="btn btn-primary"
                    onclick="submitBulk('window', null)">
              Set Access Window
            </button>
          </div>

          <input type="hidden" name="enabled" id="bulkEnabled">
          <input type="hidden" name="mode" id="bulkMode">
          <!-- ids will be injected here by JS as multiple hidden inputs -->
        </div>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead>
        <tr>
          <th class="col-narrow">No</th>
          <th>Name</th>
          <th class="col-narrow">Student&nbsp;ID</th>
          <th class="col-narrow">Session</th>
          <th>Company</th>
          <th class="col-narrow">Status</th>
          <th style="min-width:420px">Access Window</th>
          <th class="col-narrow text-center">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="student, iterStat : ${students.content}">
          <!-- No + checkbox -->
          <td>
            <div class="form-check">
              <input class="form-check-input student-check"
                     type="checkbox"
                     th:value="${student.id}"
                     th:id="${'stu-' + student.id}">
              <label class="form-check-label"
                     th:for="${'stu-' + student.id}"
                     th:text="${iterStat.index + 1}">1</label>
            </div>
          </td>

          <td th:text="${student.name}">John Doe</td>
          <td class="text-monospace" th:text="${student.studentId}">213844</td>
          <td th:text="${student.session}">2024/2025-2</td>
          <td th:text="${student.company}">Huawei</td>

          <!-- Status -->
          <td class="col-narrow">
            <div class="d-flex flex-column align-items-start">
              <span class="badge status-pill"
                    th:classappend="${student.enabled} ? 'status-on' : 'status-off'"
                    th:text="${student.enabled} ? 'ENABLED' : 'DISABLED'">ENABLED</span>

              <form th:action="@{/admin/users/{id}/status(id=${student.id})}" method="post" class="mt-1">
                <input type="hidden" name="backTo" value="students">
                <input type="hidden" name="enabled" th:value="${!student.enabled}">
                <button type="submit"
                        class="btn btn-sm"
                        th:classappend="${student.enabled} ? 'btn-outline-danger' : 'btn-outline-success'">
                  <i class="bi"
                     th:classappend="${student.enabled} ? ' bi-slash-circle me-1' : ' bi-check-circle me-1'"></i>
                  <span th:text="${student.enabled} ? 'Disable' : 'Enable'"></span>
                </button>
              </form>
            </div>
          </td>

          <!-- Access window -->
          <td>
            <div class="d-flex flex-wrap align-items-center gap-2">
              <div class="access-meta me-1">
                <div><strong>Start:</strong> <span th:text="${student.accessStart} ?: '-'">-</span></div>
                <div><strong>End:</strong> <span th:text="${student.accessEnd} ?: '-'">-</span></div>
              </div>

              <form th:action="@{/admin/users/{id}/access-window(id=${student.id})}" method="post"
                    class="access-form d-flex flex-wrap align-items-center gap-2">
                <div class="input-group input-group-sm w-auto">
                  <span class="input-group-text">Start</span>
                  <input class="form-control" type="date" name="start" th:value="${student.accessStart}">
                </div>
                <div class="input-group input-group-sm w-auto">
                  <span class="input-group-text">End</span>
                  <input class="form-control" type="date" name="end" th:value="${student.accessEnd}">
                </div>
                <input type="hidden" name="backTo" value="students">
                <button type="submit" class="btn btn-primary btn-sm ms-1">
                  <i class="bi bi-calendar-check me-1"></i>Set
                </button>
              </form>
            </div>
          </td>

          <!-- Actions -->
          <td class="text-center">
            <div class="action-group d-inline-flex gap-1">
              <a th:href="@{/admin/students/edit/{id}(id=${student.id})}" class="btn btn-outline-primary"
                 data-bs-toggle="tooltip" data-bs-title="Edit student">
                <i class="bi bi-pencil-square"></i>
              </a>

              <form th:action="@{/admin/students/delete/{id}(id=${student.id})}" method="post" class="d-inline"
                    onsubmit="return confirm('Delete this student?');">
                <button type="submit" class="btn btn-outline-danger" data-bs-toggle="tooltip" data-bs-title="Delete">
                  <i class="bi bi-trash3"></i>
                </button>
              </form>
            </div>
          </td>
        </tr>

        <!-- Empty state -->
        <tr th:if="${#lists.isEmpty(students.content)}">
          <td colspan="8" class="text-center py-5 text-muted">
            <i class="bi bi-people fs-3 d-block mb-2"></i>
            No students found. Try adjusting your search.
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex align-items-center justify-content-between p-2 page-footer bg-white">
      <small class="text-muted">
        Page <span th:text="${currentPage + 1}">1</span> of
        <span th:text="${students.totalPages}">1</span>
      </small>
      <nav th:if="${students.totalPages > 0}">
        <ul class="pagination pagination-sm mb-0">
          <!-- Previous -->
          <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
            <a class="page-link"
               th:href="@{/admin/students(page=${currentPage - 1},size=${size},search=${search},session=${selectedSession})}">
              Previous
            </a>
          </li>

          <!-- Page numbers -->
          <li class="page-item"
              th:each="i : ${#numbers.sequence(0, students.totalPages - 1)}"
              th:classappend="${i == currentPage} ? 'active'">
            <a class="page-link"
               th:text="${i + 1}"
               th:href="@{/admin/students(page=${i},size=${size},search=${search},session=${selectedSession})}">
              1
            </a>
          </li>

          <!-- Next -->
          <li class="page-item" th:classappend="${currentPage == students.totalPages - 1} ? 'disabled'">
            <a class="page-link"
               th:href="@{/admin/students(page=${currentPage + 1},size=${size},search=${search},session=${selectedSession})}">
              Next
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</main>

<footer class="text-center text-muted py-4 small">
  © <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}">2025</span>, UPM
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // tooltips for action icons
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

  // select all checkboxes
  const selectAll = document.getElementById('selectAll');
  if (selectAll) {
    selectAll.addEventListener('change', function () {
      document.querySelectorAll('.student-check').forEach(cb => {
        cb.checked = selectAll.checked;
      });
    });
  }

  // submit bulk actions
  function submitBulk(mode, enabledFlag) {
    const form = document.getElementById('bulkForm');
    const checks = document.querySelectorAll('.student-check:checked');

    if (!checks.length) {
      alert('Please select at least one student.');
      return;
    }

    // remove any previous dynamic id inputs
    Array.from(form.querySelectorAll('input[name="ids"]')).forEach(el => el.remove());

    // add selected ids as hidden inputs
    checks.forEach(cb => {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'ids';
      hidden.value = cb.value;
      form.appendChild(hidden);
    });

    document.getElementById('bulkMode').value = mode;
    if (enabledFlag !== null) {
      document.getElementById('bulkEnabled').value = enabledFlag;
    }

    form.submit();
  }
</script>
</body>
</html>
